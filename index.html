<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Sekolah Digital - SMK Teknologi Maju</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-ring {
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.33); }
            80%, 100% { opacity: 0; }
        }
        .timer-warning {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-blue-500">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-lg">üè´</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Sistem Sekolah Digital</h1>
                        <p class="text-sm text-gray-600">SMK Teknologi Maju</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="currentTime" class="text-sm text-gray-600"></span>
                    <button onclick="showLogin()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        Login Admin
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Login Modal -->
        <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
            <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 fade-in">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Login Admin</h2>
                <form onsubmit="handleLogin(event)">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Username</label>
                        <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan username" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                        <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan password" required>
                    </div>
                    <div class="flex space-x-3">
                        <button type="button" onclick="hideLogin()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg transition-colors">
                            Batal
                        </button>
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg transition-colors">
                            Login
                        </button>
                    </div>
                </form>
                <p class="text-xs text-gray-500 mt-4 text-center">Demo: admin / admin123</p>
            </div>
        </div>

        <!-- Teacher Login Modal -->
        <div id="teacherLoginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
            <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 fade-in">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Login Guru</h2>
                <form onsubmit="handleTeacherLogin(event)">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Username</label>
                        <input type="text" id="teacherLoginUsername" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Masukkan username guru" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                        <input type="password" id="teacherLoginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Masukkan password" required>
                    </div>
                    <div class="flex space-x-3">
                        <button type="button" onclick="hideTeacherLogin()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg transition-colors">
                            Batal
                        </button>
                        <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg transition-colors">
                            Login
                        </button>
                    </div>
                </form>
                <p class="text-xs text-gray-500 mt-4 text-center">Demo: ahmad.susanto / guru123</p>
            </div>
        </div>

        <!-- Public Section -->
        <div id="publicSection" class="space-y-8">
            <!-- Main Menu -->
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Pilih Layanan</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <button onclick="showAttendanceMenu()" class="service-card bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white p-8 rounded-xl transition-all transform hover:scale-105">
                        <div class="text-5xl mb-4">üìù</div>
                        <h3 class="text-2xl font-bold mb-3">Sistem Absensi</h3>
                        <p class="text-green-100">Absensi untuk guru, karyawan, dan siswa</p>
                    </button>
                    <button onclick="showExamMenu()" class="service-card bg-gradient-to-br from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white p-8 rounded-xl transition-all transform hover:scale-105">
                        <div class="text-5xl mb-4">üìö</div>
                        <h3 class="text-2xl font-bold mb-3">Ujian Online</h3>
                        <p class="text-purple-100">Sistem ujian digital untuk siswa</p>
                    </button>
                </div>
            </div>

            <!-- Attendance Menu -->
            <div id="attendanceMenu" class="bg-white rounded-xl shadow-lg p-8 hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Pilih Jenis Absensi</h2>
                    <button onclick="backToMainMenu()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="grid md:grid-cols-3 gap-6">
                    <button onclick="showTeacherLogin()" class="role-card bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white p-6 rounded-xl transition-all transform hover:scale-105">
                        <div class="text-4xl mb-3">üë®‚Äçüè´</div>
                        <h3 class="text-xl font-bold mb-2">Guru</h3>
                        <p class="text-green-100">Login dengan akun guru</p>
                    </button>
                    <button onclick="selectRole('karyawan')" class="role-card bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white p-6 rounded-xl transition-all transform hover:scale-105">
                        <div class="text-4xl mb-3">üë®‚Äçüíº</div>
                        <h3 class="text-xl font-bold mb-2">Karyawan</h3>
                        <p class="text-blue-100">Absensi untuk staff sekolah</p>
                    </button>
                    <button onclick="selectRole('siswa')" class="role-card bg-gradient-to-br from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white p-6 rounded-xl transition-all transform hover:scale-105">
                        <div class="text-4xl mb-3">üë®‚Äçüéì</div>
                        <h3 class="text-xl font-bold mb-2">Siswa</h3>
                        <p class="text-purple-100">Absensi untuk peserta didik</p>
                    </button>
                </div>
            </div>

            <!-- Exam Menu -->
            <div id="examMenu" class="bg-white rounded-xl shadow-lg p-8 hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Ujian Online</h2>
                    <button onclick="backToMainMenu()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Student Login for Exam -->
                <div class="max-w-md mx-auto">
                    <form onsubmit="handleStudentLogin(event)" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">NIS Siswa</label>
                            <input type="text" id="studentNIS" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Masukkan NIS" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Nama Lengkap</label>
                            <input type="text" id="studentName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Masukkan nama lengkap" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Kelas</label>
                            <select id="studentClass" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                                <option value="">Pilih Kelas</option>
                                <option value="X RPL 1">X RPL 1</option>
                                <option value="X RPL 2">X RPL 2</option>
                                <option value="XI RPL 1">XI RPL 1</option>
                                <option value="XI RPL 2">XI RPL 2</option>
                                <option value="XII RPL 1">XII RPL 1</option>
                                <option value="XII RPL 2">XII RPL 2</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg transition-colors">
                            Masuk ke Ujian
                        </button>
                    </form>
                </div>
            </div>

            <!-- Available Exams -->
            <div id="examList" class="bg-white rounded-xl shadow-lg p-8 hidden">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Ujian Tersedia</h2>
                        <p class="text-gray-600">Selamat datang, <span id="welcomeStudent"></span></p>
                    </div>
                    <button onclick="logoutStudent()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="grid md:grid-cols-2 gap-6" id="examCards">
                    <!-- Exam cards will be populated here -->
                </div>
            </div>

            <!-- Exam Interface -->
            <div id="examInterface" class="bg-white rounded-xl shadow-lg p-8 hidden">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900" id="examTitle"></h2>
                        <p class="text-gray-600" id="examInfo"></p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-red-600" id="examTimer">00:00</div>
                        <p class="text-sm text-gray-600">Waktu tersisa</p>
                    </div>
                </div>
                
                <div class="mb-6">
                    <div class="bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" id="progressBar" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Soal <span id="currentQuestion">1</span> dari <span id="totalQuestions">10</span></p>
                </div>
                
                <div id="questionContainer" class="mb-8">
                    <!-- Questions will be populated here -->
                </div>
                
                <div class="flex justify-between">
                    <button onclick="previousQuestion()" id="prevBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-3 rounded-lg transition-colors disabled:opacity-50" disabled>
                        ‚Üê Sebelumnya
                    </button>
                    <button onclick="nextQuestion()" id="nextBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-colors">
                        Selanjutnya ‚Üí
                    </button>
                    <button onclick="finishExam()" id="finishBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors hidden">
                        Selesai Ujian
                    </button>
                </div>
            </div>

            <!-- Exam Result -->
            <div id="examResult" class="bg-white rounded-xl shadow-lg p-8 hidden">
                <div class="text-center">
                    <div class="text-6xl mb-4">üéâ</div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">Ujian Selesai!</h2>
                    <div class="bg-gray-50 rounded-lg p-6 mb-6">
                        <div class="grid md:grid-cols-3 gap-4 text-center">
                            <div>
                                <p class="text-2xl font-bold text-blue-600" id="finalScore">0</p>
                                <p class="text-gray-600">Nilai</p>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-green-600" id="correctAnswers">0</p>
                                <p class="text-gray-600">Benar</p>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-red-600" id="wrongAnswers">0</p>
                                <p class="text-gray-600">Salah</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="backToExamList()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg transition-colors">
                        Kembali ke Daftar Ujian
                    </button>
                </div>
            </div>

            <!-- Attendance Form (existing code) -->
            <div id="attendanceForm" class="bg-white rounded-xl shadow-lg p-8 hidden">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Absensi <span id="selectedRoleTitle"></span></h2>
                        <p id="teacherWelcome" class="text-sm text-gray-600 hidden"></p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button id="teacherLogoutBtn" onclick="logoutTeacher()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-colors hidden">
                            Logout Guru
                        </button>
                        <button onclick="backToAttendanceMenu()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <form onsubmit="handleAttendance(event)" class="space-y-6">
                    <div class="grid md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Nama Lengkap</label>
                            <input type="text" id="fullName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan nama lengkap" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">NIP/NIS</label>
                            <input type="text" id="idNumber" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan NIP/NIS" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Jenis Absensi</label>
                            <select id="attendanceType" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required onchange="checkAttendanceTime()">
                                <option value="">Pilih Jenis Absensi</option>
                                <option value="masuk">Absen Masuk</option>
                                <option value="pulang">Absen Pulang</option>
                            </select>
                        </div>
                    </div>

                    <!-- Time Warning -->
                    <div id="timeWarning" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-start space-x-3">
                            <span class="text-yellow-600 text-xl">‚ö†Ô∏è</span>
                            <div>
                                <h4 class="font-medium text-yellow-800 mb-1">Peringatan Waktu</h4>
                                <p id="timeWarningText" class="text-sm text-yellow-700"></p>
                            </div>
                        </div>
                    </div>

                    <div id="siswaFields" class="hidden">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-2">Kelas</label>
                                <select id="kelas" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Pilih Kelas</option>
                                    <option value="X RPL 1">X RPL 1</option>
                                    <option value="X RPL 2">X RPL 2</option>
                                    <option value="XI RPL 1">XI RPL 1</option>
                                    <option value="XI RPL 2">XI RPL 2</option>
                                    <option value="XII RPL 1">XII RPL 1</option>
                                    <option value="XII RPL 2">XII RPL 2</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-2">Jurusan</label>
                                <select id="jurusan" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Pilih Jurusan</option>
                                    <option value="RPL">Rekayasa Perangkat Lunak</option>
                                    <option value="TKJ">Teknik Komputer Jaringan</option>
                                    <option value="MM">Multimedia</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Camera Section -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">üì∏ Foto Absensi</h3>
                        <div class="flex flex-col items-center space-y-4">
                            <video id="camera" class="w-full max-w-md rounded-lg shadow-lg hidden" autoplay></video>
                            <canvas id="photoCanvas" class="w-full max-w-md rounded-lg shadow-lg hidden"></canvas>
                            <img id="capturedPhoto" class="w-full max-w-md rounded-lg shadow-lg hidden" alt="Foto yang diambil">
                            
                            <div class="flex flex-wrap gap-3 justify-center">
                                <button type="button" id="startCameraBtn" onclick="startCamera()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-colors inline-flex items-center space-x-2">
                                    <span>üì∑</span>
                                    <span>Buka Kamera</span>
                                </button>
                                <button type="button" id="captureBtn" onclick="capturePhoto()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors hidden inline-flex items-center space-x-2">
                                    <span>üì∏</span>
                                    <span>Ambil Foto</span>
                                </button>
                                <button type="button" id="retakeBtn" onclick="retakePhoto()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg transition-colors hidden inline-flex items-center space-x-2">
                                    <span>üîÑ</span>
                                    <span>Foto Ulang</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- GPS Section -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">üìç Lokasi GPS</h3>
                        
                        <!-- Location Permission Guide -->
                        <div id="locationGuide" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <h4 class="font-medium text-blue-900 mb-2">üìç Validasi Lokasi Absensi:</h4>
                            <div class="text-sm text-blue-800 space-y-1">
                                <p><strong>‚Ä¢ Lokasi Wajib:</strong> <span id="locationGuideName">SMK Muhammadiyah Bojong</span></p>
                                <p><strong>‚Ä¢ Radius Valid:</strong> <span id="locationGuideRadius">1000</span> meter dari sekolah</p>
                                <p>1. Klik "Dapatkan Lokasi" untuk menggunakan GPS</p>
                                <p>2. Pastikan Anda berada di area sekolah atau sekitarnya</p>
                                <p>3. GPS harus berhasil untuk melanjutkan absensi</p>
                                <p><strong>‚úÖ Radius sudah diperbesar menjadi 1KM untuk kemudahan absensi</strong></p>
                                <p><strong>üí° Jika masih gagal:</strong> Minta admin ubah radius di Setting Lokasi</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start justify-between gap-4">
                            <div class="flex-1">
                                <p id="locationStatus" class="text-gray-600">Klik tombol untuk mendapatkan lokasi</p>
                                <p id="locationCoords" class="text-sm text-gray-500 mt-1 hidden"></p>
                            </div>
                            <div class="flex flex-col space-y-2">
                                <button type="button" id="getLocationBtn" onclick="getLocation()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg transition-colors inline-flex items-center space-x-2">
                                    <span>üìç</span>
                                    <span>Dapatkan Lokasi</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button type="button" onclick="backToAttendanceMenu()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg transition-colors">
                            Kembali
                        </button>
                        <button type="submit" id="submitBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg transition-colors disabled:bg-gray-400" disabled>
                            Kirim Absensi
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="hidden space-y-8">
            <div class="flex justify-between items-center">
                <h2 class="text-3xl font-bold text-gray-900">Dashboard Admin</h2>
                <div class="flex flex-wrap gap-3">
                    <button onclick="showTeacherManagement()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        Kelola Data Guru
                    </button>
                    <button onclick="showSubjectManagement()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors">
                        Kelola Mata Pelajaran
                    </button>
                    <button onclick="showManualAttendance()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-colors">
                        Input Absensi Manual
                    </button>
                    <button onclick="showAdminExams()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                        Kelola Ujian
                    </button>
                    <button onclick="showLocationSettings()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg transition-colors">
                        Setting Lokasi
                    </button>
                    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                        Logout
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid md:grid-cols-5 gap-6">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Total Absensi Hari Ini</p>
                            <p class="text-3xl font-bold text-blue-600" id="totalToday">0</p>
                        </div>
                        <div class="text-4xl">üìä</div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Guru Hadir</p>
                            <p class="text-3xl font-bold text-green-600" id="guruHadir">0</p>
                        </div>
                        <div class="text-4xl">üë®‚Äçüè´</div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Karyawan Hadir</p>
                            <p class="text-3xl font-bold text-blue-600" id="karyawanHadir">0</p>
                        </div>
                        <div class="text-4xl">üë®‚Äçüíº</div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Siswa Hadir</p>
                            <p class="text-3xl font-bold text-purple-600" id="siswaHadir">0</p>
                        </div>
                        <div class="text-4xl">üë®‚Äçüéì</div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Ujian Aktif</p>
                            <p class="text-3xl font-bold text-orange-600" id="activeExams">0</p>
                        </div>
                        <div class="text-4xl">üìù</div>
                    </div>
                </div>
            </div>

            <!-- Attendance Data Table (existing) -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <div class="flex items-center space-x-4">
                        <h3 class="text-xl font-bold text-gray-900">Data Absensi</h3>
                        <span class="text-sm text-gray-500" id="lastUpdate">Terakhir diperbarui: -</span>
                    </div>
                    <div class="flex flex-wrap items-center gap-4">
                        <button onclick="refreshData()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2">
                            <span>üîÑ</span>
                            <span>Refresh</span>
                        </button>
                        <select id="filterRole" onchange="filterData()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Semua Role</option>
                            <option value="guru">Guru</option>
                            <option value="karyawan">Karyawan</option>
                            <option value="siswa">Siswa</option>
                        </select>
                        <select id="filterType" onchange="filterData()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Semua Jenis</option>
                            <option value="masuk">Absen Masuk</option>
                            <option value="pulang">Absen Pulang</option>
                        </select>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Dari:</label>
                            <input type="date" id="filterDateFrom" onchange="filterData()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Sampai:</label>
                            <input type="date" id="filterDateTo" onchange="filterData()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        <button onclick="resetFilters()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2 text-sm">
                            <span>üîÑ</span>
                            <span>Reset Filter</span>
                        </button>
                        <button onclick="exportToCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2">
                            <span>üì•</span>
                            <span>Export CSV</span>
                        </button>
                        <button onclick="exportToExcel()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2">
                            <span>üìä</span>
                            <span>Export Excel</span>
                        </button>
                        <button onclick="exportRecapToExcel()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2">
                            <span>üìã</span>
                            <span>Rekap Absensi</span>
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Waktu</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Role</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Jenis</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">NIP/NIS</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Kelas/Jurusan</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Lokasi</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Foto</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTable" class="divide-y divide-gray-200">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Exam Management -->
            <div id="examManagement" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Kelola Ujian</h3>
                    <div class="flex space-x-4">
                        <button onclick="showCreateExam()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                            Buat Ujian Baru
                        </button>
                        <button onclick="hideAdminExams()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg transition-colors">
                            Kembali
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Mata Pelajaran</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Kelas</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Durasi</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Soal</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="examManagementTable" class="divide-y divide-gray-200">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Teacher Management -->
            <div id="teacherManagement" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Kelola Data Guru</h3>
                    <div class="flex space-x-4">
                        <button onclick="showAddTeacher()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                            Tambah Guru Baru
                        </button>
                        <button onclick="hideTeacherManagement()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg transition-colors">
                            Kembali
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">NIP</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama Lengkap</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Email</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">No. Telepon</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Mata Pelajaran</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="teacherTable" class="divide-y divide-gray-200">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Add Teacher Form -->
            <div id="addTeacherForm" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Tambah Data Guru</h3>
                    <button onclick="hideAddTeacher()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form onsubmit="addTeacher(event)" class="space-y-6">
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">NIP</label>
                            <input type="text" id="teacherNIP" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Contoh: 198501012010011001" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Nama Lengkap</label>
                            <input type="text" id="teacherName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Contoh: Dr. Ahmad Susanto, S.Pd" required>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Email</label>
                            <input type="email" id="teacherEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Contoh: ahmad.susanto@smk.sch.id" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">No. Telepon</label>
                            <input type="tel" id="teacherPhone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Contoh: 081234567890" required>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Mata Pelajaran</label>
                            <select id="teacherSubject" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                                <option value="">Pilih Mata Pelajaran</option>
                                <option value="Matematika">Matematika</option>
                                <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                                <option value="Bahasa Inggris">Bahasa Inggris</option>
                                <option value="Pemrograman Dasar">Pemrograman Dasar</option>
                                <option value="Basis Data">Basis Data</option>
                                <option value="Pemrograman Web">Pemrograman Web</option>
                                <option value="Pemrograman Berorientasi Objek">Pemrograman Berorientasi Objek</option>
                                <option value="Sistem Operasi">Sistem Operasi</option>
                                <option value="Jaringan Komputer">Jaringan Komputer</option>
                                <option value="Multimedia">Multimedia</option>
                                <option value="PKN">Pendidikan Kewarganegaraan</option>
                                <option value="Sejarah">Sejarah</option>
                                <option value="Fisika">Fisika</option>
                                <option value="Kimia">Kimia</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Jenis Kelamin</label>
                            <select id="teacherGender" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                                <option value="">Pilih Jenis Kelamin</option>
                                <option value="Laki-laki">Laki-laki</option>
                                <option value="Perempuan">Perempuan</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Tanggal Lahir</label>
                            <input type="date" id="teacherBirthDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Status</label>
                            <select id="teacherStatus" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                                <option value="">Pilih Status</option>
                                <option value="PNS">PNS</option>
                                <option value="Honorer">Honorer</option>
                                <option value="Kontrak">Kontrak</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Alamat</label>
                        <textarea id="teacherAddress" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" rows="3" placeholder="Alamat lengkap guru..." required></textarea>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-medium text-blue-900 mb-2">üîê Akun Login Guru</h4>
                        <p class="text-sm text-blue-700 mb-3">Akun ini akan digunakan guru untuk login ke sistem</p>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-blue-700 text-sm font-medium mb-2">Username</label>
                                <input type="text" id="teacherUsername" class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Contoh: ahmad.susanto" required>
                            </div>
                            <div>
                                <label class="block text-blue-700 text-sm font-medium mb-2">Password</label>
                                <input type="password" id="teacherPassword" class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Minimal 6 karakter" minlength="6" required>
                            </div>
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button type="button" onclick="hideAddTeacher()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg transition-colors">
                            Batal
                        </button>
                        <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg transition-colors">
                            Simpan Data Guru
                        </button>
                    </div>
                </form>
            </div>

            <!-- Edit Teacher Form -->
            <div id="editTeacherForm" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Edit Data Guru</h3>
                    <button onclick="hideEditTeacher()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form onsubmit="updateTeacher(event)" class="space-y-6">
                    <input type="hidden" id="editTeacherId">
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">NIP</label>
                            <input type="text" id="editTeacherNIP" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Nama Lengkap</label>
                            <input type="text" id="editTeacherName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Email</label>
                            <input type="email" id="editTeacherEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">No. Telepon</label>
                            <input type="tel" id="editTeacherPhone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Mata Pelajaran</label>
                            <select id="editTeacherSubject" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                                <option value="">Pilih Mata Pelajaran</option>
                                <option value="Matematika">Matematika</option>
                                <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                                <option value="Bahasa Inggris">Bahasa Inggris</option>
                                <option value="Pemrograman Dasar">Pemrograman Dasar</option>
                                <option value="Basis Data">Basis Data</option>
                                <option value="Pemrograman Web">Pemrograman Web</option>
                                <option value="Pemrograman Berorientasi Objek">Pemrograman Berorientasi Objek</option>
                                <option value="Sistem Operasi">Sistem Operasi</option>
                                <option value="Jaringan Komputer">Jaringan Komputer</option>
                                <option value="Multimedia">Multimedia</option>
                                <option value="PKN">Pendidikan Kewarganegaraan</option>
                                <option value="Sejarah">Sejarah</option>
                                <option value="Fisika">Fisika</option>
                                <option value="Kimia">Kimia</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Status</label>
                            <select id="editTeacherStatus" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                                <option value="">Pilih Status</option>
                                <option value="PNS">PNS</option>
                                <option value="Honorer">Honorer</option>
                                <option value="Kontrak">Kontrak</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h4 class="font-medium text-yellow-900 mb-2">üîê Update Password (Opsional)</h4>
                        <p class="text-sm text-yellow-700 mb-3">Kosongkan jika tidak ingin mengubah password</p>
                        <div>
                            <label class="block text-yellow-700 text-sm font-medium mb-2">Password Baru</label>
                            <input type="password" id="editTeacherPassword" class="w-full px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 text-sm" placeholder="Minimal 6 karakter" minlength="6">
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button type="button" onclick="hideEditTeacher()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg transition-colors">
                            Batal
                        </button>
                        <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg transition-colors">
                            Update Data Guru
                        </button>
                    </div>
                </form>
            </div>

            <!-- Subject Management -->
            <div id="subjectManagement" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Kelola Mata Pelajaran</h3>
                    <div class="flex space-x-4">
                        <button onclick="showAddSubject()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                            Tambah Mata Pelajaran
                        </button>
                        <button onclick="hideSubjectManagement()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg transition-colors">
                            Kembali
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Kode</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama Mata Pelajaran</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Kategori</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Kelas</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="subjectTable" class="divide-y divide-gray-200">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Add Subject Form -->
            <div id="addSubjectForm" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Tambah Mata Pelajaran</h3>
                    <button onclick="hideAddSubject()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form onsubmit="addSubject(event)" class="space-y-6">
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Kode Mata Pelajaran</label>
                            <input type="text" id="subjectCode" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Contoh: MTK001" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Nama Mata Pelajaran</label>
                            <input type="text" id="subjectName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Contoh: Matematika" required>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Kategori</label>
                        <select id="subjectCategory" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required>
                            <option value="">Pilih Kategori</option>
                            <option value="Umum">Mata Pelajaran Umum</option>
                            <option value="Kejuruan">Mata Pelajaran Kejuruan</option>
                            <option value="Muatan Lokal">Muatan Lokal</option>
                            <option value="Ekstrakurikuler">Ekstrakurikuler</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Kelas yang Mengambil</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="X RPL 1" class="subject-class-checkbox">
                                <span class="text-sm">X RPL 1</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="X RPL 2" class="subject-class-checkbox">
                                <span class="text-sm">X RPL 2</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="XI RPL 1" class="subject-class-checkbox">
                                <span class="text-sm">XI RPL 1</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="XI RPL 2" class="subject-class-checkbox">
                                <span class="text-sm">XI RPL 2</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="XII RPL 1" class="subject-class-checkbox">
                                <span class="text-sm">XII RPL 1</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="XII RPL 2" class="subject-class-checkbox">
                                <span class="text-sm">XII RPL 2</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Deskripsi</label>
                        <textarea id="subjectDescription" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" rows="3" placeholder="Deskripsi mata pelajaran..."></textarea>
                    </div>

                    <div class="flex space-x-4">
                        <button type="button" onclick="hideAddSubject()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg transition-colors">
                            Batal
                        </button>
                        <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg transition-colors">
                            Simpan Mata Pelajaran
                        </button>
                    </div>
                </form>
            </div>

            <!-- Edit Subject Form -->
            <div id="editSubjectForm" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Edit Mata Pelajaran</h3>
                    <button onclick="hideEditSubject()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form onsubmit="updateSubject(event)" class="space-y-6">
                    <input type="hidden" id="editSubjectId">
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Kode Mata Pelajaran</label>
                            <input type="text" id="editSubjectCode" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Nama Mata Pelajaran</label>
                            <input type="text" id="editSubjectName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Kategori</label>
                        <select id="editSubjectCategory" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required>
                            <option value="">Pilih Kategori</option>
                            <option value="Umum">Mata Pelajaran Umum</option>
                            <option value="Kejuruan">Mata Pelajaran Kejuruan</option>
                            <option value="Muatan Lokal">Muatan Lokal</option>
                            <option value="Ekstrakurikuler">Ekstrakurikuler</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Kelas yang Mengambil</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="X RPL 1" class="edit-subject-class-checkbox">
                                <span class="text-sm">X RPL 1</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="X RPL 2" class="edit-subject-class-checkbox">
                                <span class="text-sm">X RPL 2</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="XI RPL 1" class="edit-subject-class-checkbox">
                                <span class="text-sm">XI RPL 1</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="XI RPL 2" class="edit-subject-class-checkbox">
                                <span class="text-sm">XI RPL 2</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="XII RPL 1" class="edit-subject-class-checkbox">
                                <span class="text-sm">XII RPL 1</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="XII RPL 2" class="edit-subject-class-checkbox">
                                <span class="text-sm">XII RPL 2</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Deskripsi</label>
                        <textarea id="editSubjectDescription" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" rows="3"></textarea>
                    </div>

                    <div class="flex space-x-4">
                        <button type="button" onclick="hideEditSubject()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg transition-colors">
                            Batal
                        </button>
                        <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg transition-colors">
                            Update Mata Pelajaran
                        </button>
                    </div>
                </form>
            </div>

            <!-- Manual Attendance Form -->
            <div id="manualAttendanceForm" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Input Absensi Manual</h3>
                    <button onclick="hideManualAttendance()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h4 class="font-medium text-blue-900 mb-2">üìù Kapan Menggunakan Input Manual?</h4>
                    <div class="text-sm text-blue-800 space-y-1">
                        <p>‚Ä¢ Guru/Karyawan/Siswa sakit dan tidak bisa hadir</p>
                        <p>‚Ä¢ Ada yang izin untuk keperluan keluarga</p>
                        <p>‚Ä¢ Guru sedang tugas dinas di luar sekolah</p>
                        <p>‚Ä¢ Karyawan mengambil cuti</p>
                        <p>‚Ä¢ Koreksi data absensi yang salah input</p>
                    </div>
                </div>

                <form onsubmit="addManualAttendance(event)" class="space-y-6">
                    <div class="grid md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Role</label>
                            <select id="manualRole" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" required onchange="toggleManualSiswaFields()">
                                <option value="">Pilih Role</option>
                                <option value="guru">Guru</option>
                                <option value="karyawan">Karyawan</option>
                                <option value="siswa">Siswa</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Nama Lengkap</label>
                            <select id="manualName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" required onchange="fillTeacherData()">
                                <option value="">Pilih Nama</option>
                            </select>
                            <input type="text" id="manualNameInput" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent hidden" placeholder="Masukkan nama lengkap" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">NIP/NIS</label>
                            <input type="text" id="manualIdNumber" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Masukkan NIP/NIS" required>
                        </div>
                    </div>

                    <div id="manualSiswaFields" class="hidden">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-2">Kelas</label>
                                <select id="manualKelas" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                    <option value="">Pilih Kelas</option>
                                    <option value="X RPL 1">X RPL 1</option>
                                    <option value="X RPL 2">X RPL 2</option>
                                    <option value="XI RPL 1">XI RPL 1</option>
                                    <option value="XI RPL 2">XI RPL 2</option>
                                    <option value="XII RPL 1">XII RPL 1</option>
                                    <option value="XII RPL 2">XII RPL 2</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-2">Jurusan</label>
                                <select id="manualJurusan" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                    <option value="">Pilih Jurusan</option>
                                    <option value="RPL">Rekayasa Perangkat Lunak</option>
                                    <option value="TKJ">Teknik Komputer Jaringan</option>
                                    <option value="MM">Multimedia</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Jenis Absensi</label>
                            <select id="manualAttendanceType" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" required>
                                <option value="">Pilih Jenis Absensi</option>
                                <option value="masuk">Absen Masuk</option>
                                <option value="pulang">Absen Pulang</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Status Kehadiran</label>
                            <select id="manualStatus" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" required>
                                <option value="">Pilih Status</option>
                                <option value="HADIR">Hadir</option>
                                <option value="SAKIT">Sakit</option>
                                <option value="IZIN">Izin</option>
                                <option value="ALPHA">Alpha</option>
                                <option value="TUGAS DINAS">Tugas Dinas</option>
                                <option value="CUTI">Cuti</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Tanggal</label>
                            <input type="date" id="manualDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Waktu</label>
                            <input type="time" id="manualTime" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" required>
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Lokasi</label>
                        <input type="text" id="manualLocation" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Contoh: Ruang Guru, Rumah Sakit, Kantor Dinas" required>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Keterangan</label>
                        <textarea id="manualKeterangan" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" rows="3" placeholder="Keterangan tambahan (opsional)..."></textarea>
                    </div>

                    <div class="flex space-x-4">
                        <button type="button" onclick="hideManualAttendance()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg transition-colors">
                            Batal
                        </button>
                        <button type="submit" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white py-3 rounded-lg transition-colors">
                            Simpan Absensi Manual
                        </button>
                    </div>
                </form>
            </div>

            <!-- Location Settings -->
            <div id="locationSettings" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Setting Lokasi Sekolah</h3>
                    <button onclick="hideLocationSettings()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h4 class="font-medium text-blue-900 mb-2">üìç Informasi Setting Lokasi</h4>
                    <div class="text-sm text-blue-800 space-y-1">
                        <p>‚Ä¢ Setting ini menentukan lokasi yang valid untuk absensi</p>
                        <p>‚Ä¢ Semua absensi harus dilakukan dalam radius yang ditentukan dari lokasi sekolah</p>
                        <p>‚Ä¢ Koordinat GPS akan digunakan untuk validasi lokasi absensi</p>
                    </div>
                </div>

                <form onsubmit="saveLocationSettings(event)" class="space-y-6">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Nama Sekolah</label>
                        <input type="text" id="schoolName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent" value="SMK Muhammadiyah Bojong" required>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Alamat Lengkap</label>
                        <textarea id="schoolAddress" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent" rows="3" placeholder="Masukkan alamat lengkap sekolah..." required>Jl. Raya Bojong, Bojong, Kec. Bojong, Kabupaten Pekalongan, Jawa Tengah 51156</textarea>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Latitude</label>
                            <input type="number" id="schoolLatitude" step="any" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent" value="-6.914700" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Longitude</label>
                            <input type="number" id="schoolLongitude" step="any" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent" value="109.676200" required>
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Radius Validasi (meter)</label>
                        <select id="validationRadius" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent" required>
                            <option value="">Pilih Radius</option>
                            <option value="50">50 meter (Sangat Ketat)</option>
                            <option value="100">100 meter (Ketat)</option>
                            <option value="200">200 meter (Normal)</option>
                            <option value="500">500 meter (Longgar)</option>
                            <option value="1000" selected>1000 meter (Sangat Longgar) - RECOMMENDED</option>
                            <option value="2000">2000 meter (Sangat Fleksibel)</option>
                        </select>
                        <p class="text-sm text-gray-600 mt-1">Absensi hanya bisa dilakukan dalam radius ini dari lokasi sekolah</p>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h4 class="font-medium text-yellow-900 mb-2">üîß Cara Mendapatkan Koordinat GPS</h4>
                        <div class="text-sm text-yellow-800 space-y-1">
                            <p>1. Buka Google Maps di browser</p>
                            <p>2. Cari lokasi "SMK Muhammadiyah Bojong Pekalongan"</p>
                            <p>3. Klik kanan pada pin lokasi sekolah</p>
                            <p>4. Pilih koordinat yang muncul (contoh: -6.9147, 109.6762)</p>
                            <p>5. Copy dan paste ke form di atas</p>
                            <p><strong>üí° Tips:</strong> Jika masih tidak bisa absensi, coba perbesar radius menjadi 1000m</p>
                        </div>
                    </div>

                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h4 class="font-medium text-green-900 mb-2">üß™ Test Lokasi Saat Ini</h4>
                        <p class="text-sm text-green-800 mb-3">Klik tombol di bawah untuk test apakah lokasi Anda saat ini valid untuk absensi</p>
                        <div class="flex items-center space-x-4">
                            <button type="button" onclick="testCurrentLocation()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                üìç Test Lokasi Sekarang
                            </button>
                            <div id="testLocationResult" class="text-sm"></div>
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button type="button" onclick="hideLocationSettings()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg transition-colors">
                            Batal
                        </button>
                        <button type="submit" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white py-3 rounded-lg transition-colors">
                            Simpan Setting Lokasi
                        </button>
                    </div>
                </form>
            </div>

            <!-- Create Exam Form -->
            <div id="createExamForm" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Buat Ujian Baru</h3>
                    <button onclick="hideCreateExam()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form onsubmit="createExam(event)" class="space-y-6">
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Mata Pelajaran</label>
                            <input type="text" id="examSubject" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Contoh: Matematika" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Kelas</label>
                            <select id="examClass" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                                <option value="">Pilih Kelas</option>
                                <option value="X RPL 1">X RPL 1</option>
                                <option value="X RPL 2">X RPL 2</option>
                                <option value="XI RPL 1">XI RPL 1</option>
                                <option value="XI RPL 2">XI RPL 2</option>
                                <option value="XII RPL 1">XII RPL 1</option>
                                <option value="XII RPL 2">XII RPL 2</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Durasi (menit)</label>
                            <input type="number" id="examDuration" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="60" min="1" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Jumlah Soal</label>
                            <input type="number" id="examQuestionCount" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="10" min="1" max="50" required>
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Deskripsi</label>
                        <textarea id="examDescription" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" rows="3" placeholder="Deskripsi ujian..."></textarea>
                    </div>

                    <div class="flex space-x-4">
                        <button type="button" onclick="hideCreateExam()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg transition-colors">
                            Batal
                        </button>
                        <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg transition-colors">
                            Buat Ujian
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script>
        // Global variables
        let currentRole = '';
        let currentTeacher = null;
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || [];
        let examData = JSON.parse(localStorage.getItem('examData')) || [];
        let examResults = JSON.parse(localStorage.getItem('examResults')) || [];
        let teacherData = JSON.parse(localStorage.getItem('teacherData')) || [];
        let subjectData = JSON.parse(localStorage.getItem('subjectData')) || [];
        let locationSettings = JSON.parse(localStorage.getItem('locationSettings')) || {};
        let currentStream = null;
        let hasPhoto = false;
        let hasLocation = false;
        
        // Exam variables
        let currentStudent = null;
        let currentExam = null;
        let currentQuestionIndex = 0;
        let studentAnswers = [];
        let examTimer = null;
        let examTimeLeft = 0;

        // Sample teacher data
        if (teacherData.length === 0) {
            teacherData = [
                {
                    id: 1,
                    nip: '198501012010011001',
                    name: 'Dr. Ahmad Susanto, S.Pd',
                    email: 'ahmad.susanto@smk.sch.id',
                    phone: '081234567890',
                    subject: 'Matematika',
                    gender: 'Laki-laki',
                    birthDate: '1985-01-01',
                    status: 'PNS',
                    address: 'Jl. Pendidikan No. 123, Jakarta Selatan',
                    username: 'ahmad.susanto',
                    password: 'guru123',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 2,
                    nip: '199002152015022002',
                    name: 'Siti Nurhaliza, S.Kom',
                    email: 'siti.nurhaliza@smk.sch.id',
                    phone: '081234567891',
                    subject: 'Pemrograman Web',
                    gender: 'Perempuan',
                    birthDate: '1990-02-15',
                    status: 'PNS',
                    address: 'Jl. Teknologi No. 456, Jakarta Timur',
                    username: 'siti.nurhaliza',
                    password: 'guru123',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 3,
                    nip: '198803102012011003',
                    name: 'Budi Santoso, S.T',
                    email: 'budi.santoso@smk.sch.id',
                    phone: '081234567892',
                    subject: 'Jaringan Komputer',
                    gender: 'Laki-laki',
                    birthDate: '1988-03-10',
                    status: 'Honorer',
                    address: 'Jl. Komputer No. 789, Jakarta Barat',
                    username: 'budi.santoso',
                    password: 'guru123',
                    createdAt: new Date().toISOString()
                }
            ];
            localStorage.setItem('teacherData', JSON.stringify(teacherData));
        }

        // Sample exam data
        if (examData.length === 0) {
            examData = [
                {
                    id: 1,
                    subject: 'Matematika',
                    class: 'X RPL 1',
                    duration: 60,
                    description: 'Ujian Matematika Semester 1',
                    status: 'active',
                    questions: [
                        {
                            question: 'Berapakah hasil dari 2 + 2?',
                            options: ['3', '4', '5', '6'],
                            correct: 1
                        },
                        {
                            question: 'Berapakah hasil dari 5 √ó 3?',
                            options: ['12', '15', '18', '20'],
                            correct: 1
                        },
                        {
                            question: 'Berapakah hasil dari 10 √∑ 2?',
                            options: ['3', '4', '5', '6'],
                            correct: 2
                        },
                        {
                            question: 'Berapakah hasil dari 8 - 3?',
                            options: ['4', '5', '6', '7'],
                            correct: 1
                        },
                        {
                            question: 'Berapakah hasil dari 3¬≤?',
                            options: ['6', '8', '9', '12'],
                            correct: 2
                        }
                    ]
                },
                {
                    id: 2,
                    subject: 'Bahasa Indonesia',
                    class: 'XI RPL 1',
                    duration: 45,
                    description: 'Ujian Bahasa Indonesia - Teks Eksposisi',
                    status: 'active',
                    questions: [
                        {
                            question: 'Apa yang dimaksud dengan teks eksposisi?',
                            options: ['Teks yang berisi cerita', 'Teks yang berisi informasi', 'Teks yang berisi puisi', 'Teks yang berisi dialog'],
                            correct: 1
                        },
                        {
                            question: 'Struktur teks eksposisi terdiri dari?',
                            options: ['Orientasi-Komplikasi-Resolusi', 'Tesis-Argumentasi-Penegasan', 'Pembuka-Isi-Penutup', 'Judul-Isi-Kesimpulan'],
                            correct: 1
                        }
                    ]
                }
            ];
            localStorage.setItem('examData', JSON.stringify(examData));
        }

        // Sample subject data
        if (subjectData.length === 0) {
            subjectData = [
                {
                    id: 1,
                    code: 'MTK001',
                    name: 'Matematika',
                    category: 'Umum',
                    classes: ['X RPL 1', 'X RPL 2', 'XI RPL 1', 'XI RPL 2'],
                    description: 'Mata pelajaran matematika dasar untuk SMK',
                    status: 'active',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 2,
                    code: 'BIN001',
                    name: 'Bahasa Indonesia',
                    category: 'Umum',
                    classes: ['X RPL 1', 'X RPL 2', 'XI RPL 1', 'XI RPL 2', 'XII RPL 1', 'XII RPL 2'],
                    description: 'Mata pelajaran bahasa Indonesia untuk semua kelas',
                    status: 'active',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 3,
                    code: 'PWB001',
                    name: 'Pemrograman Web',
                    category: 'Kejuruan',
                    classes: ['XI RPL 1', 'XI RPL 2', 'XII RPL 1', 'XII RPL 2'],
                    description: 'Mata pelajaran pemrograman web untuk jurusan RPL',
                    status: 'active',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 4,
                    code: 'BDT001',
                    name: 'Basis Data',
                    category: 'Kejuruan',
                    classes: ['XI RPL 1', 'XI RPL 2', 'XII RPL 1', 'XII RPL 2'],
                    description: 'Mata pelajaran basis data untuk jurusan RPL',
                    status: 'active',
                    createdAt: new Date().toISOString()
                }
            ];
            localStorage.setItem('subjectData', JSON.stringify(subjectData));
        }

        // Default location settings
        if (Object.keys(locationSettings).length === 0) {
            locationSettings = {
                schoolName: 'SMK Muhammadiyah Bojong',
                schoolAddress: 'Jl. Raya Bojong, Bojong, Kec. Bojong, Kabupaten Pekalongan, Jawa Tengah 51156',
                schoolLatitude: -6.914700,
                schoolLongitude: 109.676200,
                validationRadius: 200
            };
            localStorage.setItem('locationSettings', JSON.stringify(locationSettings));
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
            
            // Load data from localStorage on page load
            attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || [];
            examData = JSON.parse(localStorage.getItem('examData')) || [];
            examResults = JSON.parse(localStorage.getItem('examResults')) || [];
            teacherData = JSON.parse(localStorage.getItem('teacherData')) || [];
            
            // Update location guide with current settings
            updateLocationGuide();
            
            updateStats();
            renderAttendanceTable();
            
            // Set today's date as default filter
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterDateFrom').value = today;
            document.getElementById('filterDateTo').value = today;
            
            // Auto-refresh data every 30 seconds if admin is logged in
            setInterval(() => {
                if (!document.getElementById('adminDashboard').classList.contains('hidden')) {
                    // Reload data from localStorage
                    attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || [];
                    examData = JSON.parse(localStorage.getItem('examData')) || [];
                    examResults = JSON.parse(localStorage.getItem('examResults')) || [];
                    teacherData = JSON.parse(localStorage.getItem('teacherData')) || [];
                    
                    updateStats();
                    renderAttendanceTable();
                }
            }, 30000); // Refresh every 30 seconds
        });

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        // Navigation functions
        function showLogin() {
            document.getElementById('loginModal').classList.remove('hidden');
        }

        function hideLogin() {
            document.getElementById('loginModal').classList.add('hidden');
        }

        function showTeacherLogin() {
            document.getElementById('teacherLoginModal').classList.remove('hidden');
        }

        function hideTeacherLogin() {
            document.getElementById('teacherLoginModal').classList.add('hidden');
        }

        function showAttendanceMenu() {
            document.querySelector('.grid.md\\:grid-cols-2').parentElement.classList.add('hidden');
            document.getElementById('attendanceMenu').classList.remove('hidden');
        }

        function showExamMenu() {
            document.querySelector('.grid.md\\:grid-cols-2').parentElement.classList.add('hidden');
            document.getElementById('examMenu').classList.remove('hidden');
        }

        function backToMainMenu() {
            // Hide all sections
            document.getElementById('attendanceMenu').classList.add('hidden');
            document.getElementById('examMenu').classList.add('hidden');
            document.getElementById('examList').classList.add('hidden');
            document.getElementById('attendanceForm').classList.add('hidden');
            
            // Show main menu
            document.querySelector('.grid.md\\:grid-cols-2').parentElement.classList.remove('hidden');
            
            // Reset forms
            resetForm();
            currentStudent = null;
            currentTeacher = null;
        }

        function backToAttendanceMenu() {
            if (currentTeacher) {
                // If teacher is logged in, go back to main menu
                backToMainMenu();
                currentTeacher = null;
            } else {
                // If not teacher, go back to attendance menu
                document.getElementById('attendanceForm').classList.add('hidden');
                document.getElementById('attendanceMenu').classList.remove('hidden');
            }
            stopCamera();
            resetForm();
        }

        // Login functions
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'admin' && password === 'admin123') {
                hideLogin();
                document.getElementById('publicSection').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                
                // Reload all data from localStorage to ensure fresh data
                attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || [];
                examData = JSON.parse(localStorage.getItem('examData')) || [];
                examResults = JSON.parse(localStorage.getItem('examResults')) || [];
                teacherData = JSON.parse(localStorage.getItem('teacherData')) || [];
                
                // Update dashboard
                updateStats();
                renderAttendanceTable();
                renderExamManagementTable();
                
                // Clear login form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
                console.log('Admin logged in. Data loaded:', {
                    attendance: attendanceData.length,
                    exams: examData.length,
                    results: examResults.length
                });
            } else {
                alert('Username atau password salah!');
            }
        }

        function handleTeacherLogin(event) {
            event.preventDefault();
            const username = document.getElementById('teacherLoginUsername').value;
            const password = document.getElementById('teacherLoginPassword').value;
            
            // Find teacher by username and password
            const teacher = teacherData.find(t => t.username === username && t.password === password);
            
            if (teacher) {
                currentTeacher = teacher;
                currentRole = 'guru';
                
                hideTeacherLogin();
                document.getElementById('attendanceMenu').classList.add('hidden');
                document.getElementById('attendanceForm').classList.remove('hidden');
                document.getElementById('selectedRoleTitle').textContent = 'Guru';
                
                // Pre-fill teacher data
                document.getElementById('fullName').value = teacher.name;
                document.getElementById('idNumber').value = teacher.nip;
                document.getElementById('fullName').readOnly = true;
                document.getElementById('idNumber').readOnly = true;
                
                // Hide siswa fields
                document.getElementById('siswaFields').classList.add('hidden');
                document.getElementById('kelas').required = false;
                document.getElementById('jurusan').required = false;
                
                // Update location guide with current settings
                updateLocationGuide();
                
                // Clear login form
                document.getElementById('teacherLoginUsername').value = '';
                document.getElementById('teacherLoginPassword').value = '';
                
                resetForm();
                
                // Show teacher welcome message and logout button
                document.getElementById('teacherWelcome').textContent = `Login sebagai: ${teacher.name} (${teacher.subject})`;
                document.getElementById('teacherWelcome').classList.remove('hidden');
                document.getElementById('teacherLogoutBtn').classList.remove('hidden');
                
                alert(`Selamat datang, ${teacher.name}!\nAnda berhasil login sebagai guru.`);
            } else {
                alert('Username atau password guru salah!');
            }
        }

        function logoutTeacher() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                currentTeacher = null;
                currentRole = '';
                
                // Hide teacher-specific elements
                document.getElementById('teacherWelcome').classList.add('hidden');
                document.getElementById('teacherLogoutBtn').classList.add('hidden');
                
                // Reset form fields
                document.getElementById('fullName').readOnly = false;
                document.getElementById('idNumber').readOnly = false;
                
                backToMainMenu();
                alert('Anda telah logout dari akun guru.');
            }
        }

        function logout() {
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('publicSection').classList.remove('hidden');
            document.getElementById('examManagement').classList.add('hidden');
            document.getElementById('createExamForm').classList.add('hidden');
            document.getElementById('teacherManagement').classList.add('hidden');
            document.getElementById('addTeacherForm').classList.add('hidden');
            document.getElementById('editTeacherForm').classList.add('hidden');
            document.getElementById('locationSettings').classList.add('hidden');
            currentTeacher = null;
            backToMainMenu();
        }

        // Student exam login
        function handleStudentLogin(event) {
            event.preventDefault();
            const nis = document.getElementById('studentNIS').value;
            const name = document.getElementById('studentName').value;
            const studentClass = document.getElementById('studentClass').value;
            
            currentStudent = {
                nis: nis,
                name: name,
                class: studentClass
            };
            
            document.getElementById('examMenu').classList.add('hidden');
            document.getElementById('examList').classList.remove('hidden');
            document.getElementById('welcomeStudent').textContent = name;
            
            renderExamList();
        }

        function logoutStudent() {
            currentStudent = null;
            document.getElementById('examList').classList.add('hidden');
            document.getElementById('examMenu').classList.remove('hidden');
            
            // Reset form
            document.getElementById('studentNIS').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('studentClass').value = '';
        }

        // Exam functions
        function renderExamList() {
            const container = document.getElementById('examCards');
            const availableExams = examData.filter(exam => 
                exam.status === 'active' && 
                (exam.class === currentStudent.class || exam.class === 'Semua Kelas')
            );
            
            container.innerHTML = '';
            
            availableExams.forEach(exam => {
                const card = document.createElement('div');
                card.className = 'bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-xl cursor-pointer hover:from-purple-600 hover:to-purple-700 transition-all transform hover:scale-105';
                card.onclick = () => startExam(exam.id);
                
                card.innerHTML = `
                    <div class="text-3xl mb-3">üìù</div>
                    <h3 class="text-xl font-bold mb-2">${exam.subject}</h3>
                    <p class="text-purple-100 mb-4">${exam.description}</p>
                    <div class="flex justify-between text-sm text-purple-200">
                        <span>‚è±Ô∏è ${exam.duration} menit</span>
                        <span>üìã ${exam.questions.length} soal</span>
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            if (availableExams.length === 0) {
                container.innerHTML = '<div class="col-span-2 text-center text-gray-500 py-8">Tidak ada ujian tersedia untuk kelas Anda</div>';
            }
        }

        function startExam(examId) {
            currentExam = examData.find(exam => exam.id === examId);
            if (!currentExam) return;
            
            currentQuestionIndex = 0;
            studentAnswers = new Array(currentExam.questions.length).fill(null);
            examTimeLeft = currentExam.duration * 60; // Convert to seconds
            
            document.getElementById('examList').classList.add('hidden');
            document.getElementById('examInterface').classList.remove('hidden');
            
            document.getElementById('examTitle').textContent = currentExam.subject;
            document.getElementById('examInfo').textContent = `${currentExam.description} - ${currentExam.questions.length} soal`;
            document.getElementById('totalQuestions').textContent = currentExam.questions.length;
            
            startExamTimer();
            showQuestion();
        }

        function startExamTimer() {
            examTimer = setInterval(() => {
                examTimeLeft--;
                updateTimerDisplay();
                
                if (examTimeLeft <= 0) {
                    clearInterval(examTimer);
                    finishExam();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(examTimeLeft / 60);
            const seconds = examTimeLeft % 60;
            const timerElement = document.getElementById('examTimer');
            
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Add warning class when time is running low
            if (examTimeLeft <= 300) { // 5 minutes
                timerElement.classList.add('timer-warning');
            }
        }

        function showQuestion() {
            const question = currentExam.questions[currentQuestionIndex];
            const container = document.getElementById('questionContainer');
            
            container.innerHTML = `
                <div class="bg-gray-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        ${currentQuestionIndex + 1}. ${question.question}
                    </h3>
                    <div class="space-y-3">
                        ${question.options.map((option, index) => `
                            <label class="flex items-center space-x-3 cursor-pointer p-3 rounded-lg hover:bg-white transition-colors">
                                <input type="radio" name="answer" value="${index}" 
                                       ${studentAnswers[currentQuestionIndex] === index ? 'checked' : ''}
                                       onchange="saveAnswer(${index})" 
                                       class="w-4 h-4 text-purple-600 focus:ring-purple-500">
                                <span class="text-gray-700">${String.fromCharCode(65 + index)}. ${option}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Update progress
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            const progress = ((currentQuestionIndex + 1) / currentExam.questions.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            if (currentQuestionIndex === currentExam.questions.length - 1) {
                document.getElementById('nextBtn').classList.add('hidden');
                document.getElementById('finishBtn').classList.remove('hidden');
            } else {
                document.getElementById('nextBtn').classList.remove('hidden');
                document.getElementById('finishBtn').classList.add('hidden');
            }
        }

        function saveAnswer(answerIndex) {
            studentAnswers[currentQuestionIndex] = answerIndex;
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentExam.questions.length - 1) {
                currentQuestionIndex++;
                showQuestion();
            }
        }

        function finishExam() {
            clearInterval(examTimer);
            
            // Calculate score
            let correctAnswers = 0;
            currentExam.questions.forEach((question, index) => {
                if (studentAnswers[index] === question.correct) {
                    correctAnswers++;
                }
            });
            
            const totalQuestions = currentExam.questions.length;
            const score = Math.round((correctAnswers / totalQuestions) * 100);
            
            // Save result
            const result = {
                id: Date.now(),
                studentNIS: currentStudent.nis,
                studentName: currentStudent.name,
                studentClass: currentStudent.class,
                examId: currentExam.id,
                examSubject: currentExam.subject,
                score: score,
                correctAnswers: correctAnswers,
                totalQuestions: totalQuestions,
                answers: studentAnswers,
                timestamp: new Date().toISOString(),
                date: new Date().toISOString().split('T')[0]
            };
            
            examResults.push(result);
            localStorage.setItem('examResults', JSON.stringify(examResults));
            
            // Show result
            document.getElementById('examInterface').classList.add('hidden');
            document.getElementById('examResult').classList.remove('hidden');
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('correctAnswers').textContent = correctAnswers;
            document.getElementById('wrongAnswers').textContent = totalQuestions - correctAnswers;
        }

        function backToExamList() {
            document.getElementById('examResult').classList.add('hidden');
            document.getElementById('examList').classList.remove('hidden');
            
            // Reset exam state
            currentExam = null;
            currentQuestionIndex = 0;
            studentAnswers = [];
            examTimeLeft = 0;
            
            // Reset timer display
            document.getElementById('examTimer').classList.remove('timer-warning');
        }

        // Admin exam management
        function showAdminExams() {
            document.getElementById('examManagement').classList.remove('hidden');
            renderExamManagementTable();
        }

        function hideAdminExams() {
            document.getElementById('examManagement').classList.add('hidden');
            document.getElementById('createExamForm').classList.add('hidden');
        }

        function showCreateExam() {
            document.getElementById('createExamForm').classList.remove('hidden');
        }

        function hideCreateExam() {
            document.getElementById('createExamForm').classList.add('hidden');
            
            // Reset form
            document.getElementById('examSubject').value = '';
            document.getElementById('examClass').value = '';
            document.getElementById('examDuration').value = '';
            document.getElementById('examQuestionCount').value = '';
            document.getElementById('examDescription').value = '';
        }

        function createExam(event) {
            event.preventDefault();
            
            const subject = document.getElementById('examSubject').value;
            const examClass = document.getElementById('examClass').value;
            const duration = parseInt(document.getElementById('examDuration').value);
            const questionCount = parseInt(document.getElementById('examQuestionCount').value);
            const description = document.getElementById('examDescription').value;
            
            // Generate sample questions (in real app, this would be a proper question builder)
            const questions = [];
            for (let i = 0; i < questionCount; i++) {
                questions.push({
                    question: `Soal ${i + 1} untuk ${subject}`,
                    options: ['Pilihan A', 'Pilihan B', 'Pilihan C', 'Pilihan D'],
                    correct: 0 // Default correct answer
                });
            }
            
            const newExam = {
                id: Date.now(),
                subject: subject,
                class: examClass,
                duration: duration,
                description: description,
                status: 'active',
                questions: questions
            };
            
            examData.push(newExam);
            localStorage.setItem('examData', JSON.stringify(examData));
            
            alert('Ujian berhasil dibuat!');
            hideCreateExam();
            renderExamManagementTable();
            updateStats();
        }

        function renderExamManagementTable() {
            const tbody = document.getElementById('examManagementTable');
            tbody.innerHTML = '';
            
            examData.forEach(exam => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${exam.subject}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${exam.class}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${exam.duration} menit</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${exam.questions.length} soal</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${exam.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${exam.status === 'active' ? 'Aktif' : 'Nonaktif'}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="toggleExamStatus(${exam.id})" class="text-blue-600 hover:text-blue-800 text-sm mr-3">
                            ${exam.status === 'active' ? 'Nonaktifkan' : 'Aktifkan'}
                        </button>
                        <button onclick="deleteExam(${exam.id})" class="text-red-600 hover:text-red-800 text-sm">
                            Hapus
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function toggleExamStatus(examId) {
            const exam = examData.find(e => e.id === examId);
            if (exam) {
                exam.status = exam.status === 'active' ? 'inactive' : 'active';
                localStorage.setItem('examData', JSON.stringify(examData));
                renderExamManagementTable();
                updateStats();
            }
        }

        function deleteExam(examId) {
            if (confirm('Apakah Anda yakin ingin menghapus ujian ini?')) {
                examData = examData.filter(e => e.id !== examId);
                localStorage.setItem('examData', JSON.stringify(examData));
                renderExamManagementTable();
                updateStats();
            }
        }

        // Location Settings Functions
        function showLocationSettings() {
            document.getElementById('locationSettings').classList.remove('hidden');
            loadLocationSettings();
        }

        function hideLocationSettings() {
            document.getElementById('locationSettings').classList.add('hidden');
        }

        function loadLocationSettings() {
            document.getElementById('schoolName').value = locationSettings.schoolName || 'SMK Muhammadiyah Bojong';
            document.getElementById('schoolAddress').value = locationSettings.schoolAddress || '';
            document.getElementById('schoolLatitude').value = locationSettings.schoolLatitude || '';
            document.getElementById('schoolLongitude').value = locationSettings.schoolLongitude || '';
            document.getElementById('validationRadius').value = locationSettings.validationRadius || '';
        }

        function saveLocationSettings(event) {
            event.preventDefault();

            const newSettings = {
                schoolName: document.getElementById('schoolName').value,
                schoolAddress: document.getElementById('schoolAddress').value,
                schoolLatitude: parseFloat(document.getElementById('schoolLatitude').value),
                schoolLongitude: parseFloat(document.getElementById('schoolLongitude').value),
                validationRadius: parseInt(document.getElementById('validationRadius').value)
            };

            locationSettings = newSettings;
            localStorage.setItem('locationSettings', JSON.stringify(locationSettings));

            // Update location guide if attendance form is visible
            updateLocationGuide();

            alert('Setting lokasi berhasil disimpan!\n\nSekarang semua absensi akan divalidasi berdasarkan lokasi yang telah ditentukan.');
            hideLocationSettings();
        }

        function testCurrentLocation() {
            const resultEl = document.getElementById('testLocationResult');
            const btnEl = event.target;
            const originalText = btnEl.textContent;
            
            btnEl.textContent = '‚è≥ Mencari lokasi...';
            btnEl.disabled = true;
            resultEl.textContent = '';
            
            if (!navigator.geolocation) {
                resultEl.innerHTML = '<span class="text-red-600">‚ùå Browser tidak mendukung GPS</span>';
                btnEl.textContent = originalText;
                btnEl.disabled = false;
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    // Get current settings from form
                    const schoolLat = parseFloat(document.getElementById('schoolLatitude').value) || locationSettings.schoolLatitude;
                    const schoolLng = parseFloat(document.getElementById('schoolLongitude').value) || locationSettings.schoolLongitude;
                    const radius = parseInt(document.getElementById('validationRadius').value) || locationSettings.validationRadius;
                    
                    if (!schoolLat || !schoolLng || !radius) {
                        resultEl.innerHTML = '<span class="text-yellow-600">‚ö†Ô∏è Lengkapi setting lokasi terlebih dahulu</span>';
                        btnEl.textContent = originalText;
                        btnEl.disabled = false;
                        return;
                    }
                    
                    const distance = calculateDistance(schoolLat, schoolLng, lat, lng);
                    const isValid = distance <= radius;
                    
                    if (isValid) {
                        resultEl.innerHTML = `<span class="text-green-600 font-medium">‚úÖ VALID - Jarak ${Math.round(distance)}m dari sekolah</span>`;
                    } else {
                        resultEl.innerHTML = `<span class="text-red-600 font-medium">‚ùå TERLALU JAUH - Jarak ${Math.round(distance)}m (maksimal ${radius}m)</span>`;
                    }
                    
                    resultEl.innerHTML += `<br><span class="text-gray-600 text-xs">Lokasi Anda: ${lat.toFixed(6)}, ${lng.toFixed(6)} (¬±${Math.round(accuracy)}m)</span>`;
                    
                    btnEl.textContent = originalText;
                    btnEl.disabled = false;
                },
                function(error) {
                    let errorMsg = 'Gagal mendapatkan lokasi: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += 'Izin ditolak';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += 'Lokasi tidak tersedia';
                            break;
                        case error.TIMEOUT:
                            errorMsg += 'Timeout';
                            break;
                        default:
                            errorMsg += 'Error tidak diketahui';
                            break;
                    }
                    
                    resultEl.innerHTML = `<span class="text-red-600">‚ùå ${errorMsg}</span>`;
                    btnEl.textContent = originalText;
                    btnEl.disabled = false;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 300000
                }
            );
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distance in meters
        }

        function validateLocation(userLat, userLon) {
            if (!locationSettings.schoolLatitude || !locationSettings.schoolLongitude) {
                return { valid: true, message: 'Validasi lokasi belum dikonfigurasi' };
            }

            const distance = calculateDistance(
                locationSettings.schoolLatitude,
                locationSettings.schoolLongitude,
                userLat,
                userLon
            );

            const isValid = distance <= locationSettings.validationRadius;
            
            return {
                valid: isValid,
                distance: Math.round(distance),
                message: isValid 
                    ? `Lokasi valid (${Math.round(distance)}m dari sekolah)`
                    : `Lokasi terlalu jauh (${Math.round(distance)}m dari sekolah, maksimal ${locationSettings.validationRadius}m)`
            };
        }

        // Teacher Management Functions
        function showTeacherManagement() {
            document.getElementById('teacherManagement').classList.remove('hidden');
            renderTeacherTable();
        }

        function hideTeacherManagement() {
            document.getElementById('teacherManagement').classList.add('hidden');
            document.getElementById('addTeacherForm').classList.add('hidden');
            document.getElementById('editTeacherForm').classList.add('hidden');
        }

        function showAddTeacher() {
            document.getElementById('teacherManagement').classList.add('hidden');
            document.getElementById('addTeacherForm').classList.remove('hidden');
        }

        function hideAddTeacher() {
            document.getElementById('addTeacherForm').classList.add('hidden');
            document.getElementById('teacherManagement').classList.remove('hidden');
            resetTeacherForm();
        }

        function showEditTeacher(teacherId) {
            const teacher = teacherData.find(t => t.id === teacherId);
            if (!teacher) return;

            // Hide teacher management table
            document.getElementById('teacherManagement').classList.add('hidden');

            document.getElementById('editTeacherId').value = teacher.id;
            document.getElementById('editTeacherNIP').value = teacher.nip;
            document.getElementById('editTeacherName').value = teacher.name;
            document.getElementById('editTeacherEmail').value = teacher.email;
            document.getElementById('editTeacherPhone').value = teacher.phone;
            document.getElementById('editTeacherSubject').value = teacher.subject;
            document.getElementById('editTeacherStatus').value = teacher.status;
            document.getElementById('editTeacherPassword').value = '';

            document.getElementById('editTeacherForm').classList.remove('hidden');
        }

        function hideEditTeacher() {
            document.getElementById('editTeacherForm').classList.add('hidden');
            document.getElementById('teacherManagement').classList.remove('hidden');
        }

        function resetTeacherForm() {
            document.getElementById('teacherNIP').value = '';
            document.getElementById('teacherName').value = '';
            document.getElementById('teacherEmail').value = '';
            document.getElementById('teacherPhone').value = '';
            document.getElementById('teacherSubject').value = '';
            document.getElementById('teacherGender').value = '';
            document.getElementById('teacherBirthDate').value = '';
            document.getElementById('teacherStatus').value = '';
            document.getElementById('teacherAddress').value = '';
            document.getElementById('teacherUsername').value = '';
            document.getElementById('teacherPassword').value = '';
        }

        function addTeacher(event) {
            event.preventDefault();

            const nip = document.getElementById('teacherNIP').value;
            const username = document.getElementById('teacherUsername').value;

            // Check if NIP already exists
            if (teacherData.some(teacher => teacher.nip === nip)) {
                alert('NIP sudah terdaftar! Silakan gunakan NIP yang berbeda.');
                return;
            }

            // Check if username already exists
            if (teacherData.some(teacher => teacher.username === username)) {
                alert('Username sudah digunakan! Silakan gunakan username yang berbeda.');
                return;
            }

            const newTeacher = {
                id: Date.now(),
                nip: nip,
                name: document.getElementById('teacherName').value,
                email: document.getElementById('teacherEmail').value,
                phone: document.getElementById('teacherPhone').value,
                subject: document.getElementById('teacherSubject').value,
                gender: document.getElementById('teacherGender').value,
                birthDate: document.getElementById('teacherBirthDate').value,
                status: document.getElementById('teacherStatus').value,
                address: document.getElementById('teacherAddress').value,
                username: username,
                password: document.getElementById('teacherPassword').value,
                createdAt: new Date().toISOString()
            };

            teacherData.push(newTeacher);
            localStorage.setItem('teacherData', JSON.stringify(teacherData));

            alert('Data guru berhasil ditambahkan!');
            hideAddTeacher();
            renderTeacherTable();
        }

        function updateTeacher(event) {
            event.preventDefault();

            const teacherId = parseInt(document.getElementById('editTeacherId').value);
            const teacherIndex = teacherData.findIndex(t => t.id === teacherId);
            
            if (teacherIndex === -1) {
                alert('Data guru tidak ditemukan!');
                return;
            }

            const nip = document.getElementById('editTeacherNIP').value;
            
            // Check if NIP already exists (excluding current teacher)
            if (teacherData.some(teacher => teacher.nip === nip && teacher.id !== teacherId)) {
                alert('NIP sudah terdaftar! Silakan gunakan NIP yang berbeda.');
                return;
            }

            // Update teacher data
            teacherData[teacherIndex].nip = nip;
            teacherData[teacherIndex].name = document.getElementById('editTeacherName').value;
            teacherData[teacherIndex].email = document.getElementById('editTeacherEmail').value;
            teacherData[teacherIndex].phone = document.getElementById('editTeacherPhone').value;
            teacherData[teacherIndex].subject = document.getElementById('editTeacherSubject').value;
            teacherData[teacherIndex].status = document.getElementById('editTeacherStatus').value;

            // Update password if provided
            const newPassword = document.getElementById('editTeacherPassword').value;
            if (newPassword.trim()) {
                teacherData[teacherIndex].password = newPassword;
            }

            localStorage.setItem('teacherData', JSON.stringify(teacherData));

            alert('Data guru berhasil diperbarui!');
            hideEditTeacher();
            renderTeacherTable();
        }

        function deleteTeacher(teacherId) {
            if (confirm('Apakah Anda yakin ingin menghapus data guru ini? Akun login guru juga akan dihapus.')) {
                teacherData = teacherData.filter(t => t.id !== teacherId);
                localStorage.setItem('teacherData', JSON.stringify(teacherData));
                renderTeacherTable();
                alert('Data guru berhasil dihapus!');
            }
        }

        function renderTeacherTable() {
            const tbody = document.getElementById('teacherTable');
            tbody.innerHTML = '';

            if (teacherData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center space-y-2">
                                <span class="text-4xl">üë®‚Äçüè´</span>
                                <span>Belum ada data guru</span>
                                <span class="text-sm">Klik "Tambah Guru Baru" untuk menambah data guru</span>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                teacherData.forEach(teacher => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';

                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${teacher.nip}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${teacher.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${teacher.email}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${teacher.phone}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${teacher.subject}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${getTeacherStatusBadgeClass(teacher.status)}">
                                ${teacher.status}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <button onclick="showEditTeacher(${teacher.id})" class="text-blue-600 hover:text-blue-800 text-sm mr-3">
                                Edit
                            </button>
                            <button onclick="deleteTeacher(${teacher.id})" class="text-red-600 hover:text-red-800 text-sm">
                                Hapus
                            </button>
                        </td>
                    `;

                    tbody.appendChild(row);
                });
            }
        }

        function getTeacherStatusBadgeClass(status) {
            switch(status) {
                case 'PNS': return 'bg-green-100 text-green-800';
                case 'Honorer': return 'bg-yellow-100 text-yellow-800';
                case 'Kontrak': return 'bg-blue-100 text-blue-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Attendance functions (existing code)
        function selectRole(role) {
            currentRole = role;
            document.getElementById('selectedRoleTitle').textContent = role.charAt(0).toUpperCase() + role.slice(1);
            document.getElementById('attendanceMenu').classList.add('hidden');
            document.getElementById('attendanceForm').classList.remove('hidden');
            
            // Show/hide siswa specific fields
            if (role === 'siswa') {
                document.getElementById('siswaFields').classList.remove('hidden');
                document.getElementById('kelas').required = true;
                document.getElementById('jurusan').required = true;
            } else {
                document.getElementById('siswaFields').classList.add('hidden');
                document.getElementById('kelas').required = false;
                document.getElementById('jurusan').required = false;
            }
            
            // Update location guide with current settings
            updateLocationGuide();
            
            resetForm();
        }

        function updateLocationGuide() {
            const nameEl = document.getElementById('locationGuideName');
            const radiusEl = document.getElementById('locationGuideRadius');
            
            if (nameEl) {
                nameEl.textContent = locationSettings.schoolName || 'SMK Muhammadiyah Bojong';
            }
            if (radiusEl) {
                radiusEl.textContent = locationSettings.validationRadius || 1000;
            }
        }

        function resetForm() {
            // Only reset if not a logged-in teacher
            if (!currentTeacher) {
                document.getElementById('fullName').value = '';
                document.getElementById('idNumber').value = '';
                document.getElementById('fullName').readOnly = false;
                document.getElementById('idNumber').readOnly = false;
            }
            
            document.getElementById('kelas').value = '';
            document.getElementById('jurusan').value = '';
            document.getElementById('attendanceType').value = '';
            hasPhoto = false;
            hasLocation = false;
            updateSubmitButton();
            
            // Reset time warning
            document.getElementById('timeWarning').classList.add('hidden');
            
            // Reset camera
            document.getElementById('camera').classList.add('hidden');
            document.getElementById('capturedPhoto').classList.add('hidden');
            document.getElementById('startCameraBtn').classList.remove('hidden');
            document.getElementById('captureBtn').classList.add('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            
            // Reset location
            document.getElementById('locationStatus').textContent = 'Klik tombol untuk mendapatkan lokasi';
            document.getElementById('locationStatus').className = 'text-gray-600';
            document.getElementById('locationCoords').classList.add('hidden');
            document.getElementById('getLocationBtn').classList.remove('hidden');
            document.getElementById('locationGuide').classList.remove('hidden');
        }

        function checkAttendanceTime() {
            const attendanceType = document.getElementById('attendanceType').value;
            const timeWarning = document.getElementById('timeWarning');
            const timeWarningText = document.getElementById('timeWarningText');
            
            if (!attendanceType) {
                timeWarning.classList.add('hidden');
                return;
            }
            
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes(); // Convert to minutes
            const entryTime = 7 * 60 + 15; // 07:15 in minutes
            const exitTime = 13 * 60 + 30; // 13:30 in minutes
            
            let showWarning = false;
            let warningMessage = '';
            
            if (attendanceType === 'masuk') {
                if (currentTime > entryTime) {
                    showWarning = true;
                    const lateMinutes = currentTime - entryTime;
                    const lateHours = Math.floor(lateMinutes / 60);
                    const lateRemainingMinutes = lateMinutes % 60;
                    
                    if (lateHours > 0) {
                        warningMessage = `Anda terlambat ${lateHours} jam ${lateRemainingMinutes} menit dari jam masuk (07:15). Absensi akan tercatat sebagai TERLAMBAT.`;
                    } else {
                        warningMessage = `Anda terlambat ${lateRemainingMinutes} menit dari jam masuk (07:15). Absensi akan tercatat sebagai TERLAMBAT.`;
                    }
                }
            } else if (attendanceType === 'pulang') {
                if (currentTime < exitTime) {
                    showWarning = true;
                    const earlyMinutes = exitTime - currentTime;
                    const earlyHours = Math.floor(earlyMinutes / 60);
                    const earlyRemainingMinutes = earlyMinutes % 60;
                    
                    if (earlyHours > 0) {
                        warningMessage = `Anda pulang ${earlyHours} jam ${earlyRemainingMinutes} menit lebih awal dari jam pulang (13:30). Absensi akan tercatat sebagai PULANG AWAL.`;
                    } else {
                        warningMessage = `Anda pulang ${earlyRemainingMinutes} menit lebih awal dari jam pulang (13:30). Absensi akan tercatat sebagai PULANG AWAL.`;
                    }
                }
            }
            
            if (showWarning) {
                timeWarningText.textContent = warningMessage;
                timeWarning.classList.remove('hidden');
            } else {
                timeWarning.classList.add('hidden');
            }
        }

        function getAttendanceStatus(attendanceType, timestamp) {
            const date = new Date(timestamp);
            const currentTime = date.getHours() * 60 + date.getMinutes();
            const entryTime = 7 * 60 + 15; // 07:15
            const exitTime = 13 * 60 + 30; // 13:30
            
            if (attendanceType === 'masuk') {
                return currentTime <= entryTime ? 'TEPAT WAKTU' : 'TERLAMBAT';
            } else if (attendanceType === 'pulang') {
                return currentTime >= exitTime ? 'TEPAT WAKTU' : 'PULANG AWAL';
            }
            
            return 'NORMAL';
        }

        function getStatusBadgeClass(status) {
            switch(status) {
                case 'TEPAT WAKTU': return 'bg-green-100 text-green-800';
                case 'TERLAMBAT': return 'bg-red-100 text-red-800';
                case 'PULANG AWAL': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        async function startCamera() {
            const startBtn = document.getElementById('startCameraBtn');
            const originalText = startBtn.innerHTML;
            
            try {
                startBtn.innerHTML = '<span>‚è≥</span><span>Membuka Kamera...</span>';
                startBtn.disabled = true;
                
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Browser tidak mendukung akses kamera');
                }
                
                currentStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    } 
                });
                
                const video = document.getElementById('camera');
                video.srcObject = currentStream;
                video.classList.remove('hidden');
                
                await new Promise((resolve) => {
                    video.onloadedmetadata = resolve;
                });
                
                startBtn.classList.add('hidden');
                document.getElementById('captureBtn').classList.remove('hidden');
                
            } catch (error) {
                console.error('Camera error:', error);
                
                let errorMessage = 'Tidak dapat mengakses kamera. ';
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'Izin kamera ditolak. Silakan izinkan akses kamera di browser.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'Kamera tidak ditemukan.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage += 'Browser tidak mendukung akses kamera.';
                } else {
                    errorMessage += error.message || 'Terjadi kesalahan tidak diketahui.';
                }
                
                alert(errorMessage);
                startBtn.innerHTML = originalText;
                startBtn.disabled = false;
            }
        }

        function capturePhoto() {
            const video = document.getElementById('camera');
            const canvas = document.getElementById('photoCanvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            const photoData = canvas.toDataURL('image/jpeg', 0.8);
            const img = document.getElementById('capturedPhoto');
            img.src = photoData;
            img.classList.remove('hidden');
            
            video.classList.add('hidden');
            document.getElementById('captureBtn').classList.add('hidden');
            document.getElementById('retakeBtn').classList.remove('hidden');
            
            hasPhoto = true;
            updateSubmitButton();
            stopCamera();
        }

        function retakePhoto() {
            document.getElementById('capturedPhoto').classList.add('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            document.getElementById('startCameraBtn').classList.remove('hidden');
            hasPhoto = false;
            updateSubmitButton();
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }

        function getLocation() {
            const statusEl = document.getElementById('locationStatus');
            const coordsEl = document.getElementById('locationCoords');
            const btnEl = document.getElementById('getLocationBtn');
            const originalBtnText = btnEl.innerHTML;
            
            if (!navigator.geolocation) {
                statusEl.textContent = 'Browser tidak mendukung geolocation';
                statusEl.className = 'text-red-600';
                return;
            }
            
            statusEl.textContent = 'Mendapatkan lokasi...';
            statusEl.className = 'text-blue-600';
            btnEl.innerHTML = '<span>‚è≥</span><span>Mencari Lokasi...</span>';
            btnEl.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    // Validate location against school location
                    const validation = validateLocation(lat, lng);
                    
                    if (validation.valid) {
                        statusEl.innerHTML = `‚úÖ ${validation.message}`;
                        statusEl.className = 'text-green-600 font-medium';
                        coordsEl.textContent = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)} (¬±${Math.round(accuracy)}m)`;
                        coordsEl.classList.remove('hidden');
                        btnEl.classList.add('hidden');
                        document.getElementById('locationGuide').classList.add('hidden');
                        
                        hasLocation = true;
                        updateSubmitButton();
                    } else {
                        statusEl.innerHTML = `‚ùå ${validation.message}<br><small class="text-gray-600">Anda harus berada di area ${locationSettings.schoolName} untuk melakukan absensi</small>`;
                        statusEl.className = 'text-red-600';
                        btnEl.innerHTML = originalBtnText;
                        btnEl.disabled = false;
                        
                        hasLocation = false;
                        updateSubmitButton();
                    }
                },
                function(error) {
                    console.error('Geolocation error:', error);
                    
                    let errorMsg = 'Gagal mendapatkan lokasi GPS: ';
                    let helpText = '';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += 'Izin lokasi ditolak.';
                            helpText = 'Coba refresh halaman dan klik "Allow" saat diminta izin lokasi.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += 'Lokasi tidak tersedia.';
                            helpText = 'Pastikan GPS aktif dan koneksi internet stabil.';
                            break;
                        case error.TIMEOUT:
                            errorMsg += 'Timeout.';
                            helpText = 'Coba lagi dalam beberapa saat.';
                            break;
                        default:
                            errorMsg += 'Error tidak diketahui.';
                            helpText = 'Silakan coba lagi.';
                            break;
                    }
                    
                    statusEl.innerHTML = `${errorMsg}<br><small class="text-gray-600">${helpText}</small>`;
                    statusEl.className = 'text-red-600';
                    btnEl.innerHTML = originalBtnText;
                    btnEl.disabled = false;
                    
                    hasLocation = false;
                    updateSubmitButton();
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 300000
                }
            );
        }

        function updateSubmitButton() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = !(hasPhoto && hasLocation);
        }

        function handleAttendance(event) {
            event.preventDefault();
            
            const attendanceType = document.getElementById('attendanceType').value;
            if (!attendanceType) {
                alert('Silakan pilih jenis absensi terlebih dahulu!');
                return;
            }
            
            // Get location text properly
            let locationText = '';
            const coordsEl = document.getElementById('locationCoords');
            
            if (coordsEl.textContent && !coordsEl.classList.contains('hidden')) {
                locationText = coordsEl.textContent;
            } else {
                locationText = 'Lokasi tidak tersedia';
            }
            
            const timestamp = new Date().toISOString();
            const status = getAttendanceStatus(attendanceType, timestamp);
            
            const formData = {
                id: Date.now(),
                timestamp: timestamp,
                role: currentRole,
                attendanceType: attendanceType,
                status: status,
                name: document.getElementById('fullName').value,
                idNumber: document.getElementById('idNumber').value,
                kelas: currentRole === 'siswa' ? document.getElementById('kelas').value : '',
                jurusan: currentRole === 'siswa' ? document.getElementById('jurusan').value : '',
                photo: document.getElementById('capturedPhoto').src,
                location: locationText,
                date: new Date().toISOString().split('T')[0]
            };
            
            // Load existing data, add new entry, and save back
            let existingData = JSON.parse(localStorage.getItem('attendanceData')) || [];
            existingData.push(formData);
            localStorage.setItem('attendanceData', JSON.stringify(existingData));
            
            // Update global variable
            attendanceData = existingData;
            
            // Show success message with details
            const attendanceTypeText = attendanceType === 'masuk' ? 'MASUK' : 'PULANG';
            const successMsg = `‚úÖ Absensi ${attendanceTypeText} berhasil disimpan!\n\nDetail:\n- Nama: ${formData.name}\n- Role: ${formData.role.toUpperCase()}\n- Jenis: ${attendanceTypeText}\n- Status: ${status}\n- Waktu: ${new Date(formData.timestamp).toLocaleString('id-ID')}\n- Lokasi: ${locationText}`;
            alert(successMsg);
            
            backToAttendanceMenu();
            
            // Update stats if admin is logged in
            if (!document.getElementById('adminDashboard').classList.contains('hidden')) {
                updateStats();
                renderAttendanceTable();
            }
        }

        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayData = attendanceData.filter(item => item.date === today);
            
            document.getElementById('totalToday').textContent = todayData.length;
            document.getElementById('guruHadir').textContent = todayData.filter(item => item.role === 'guru').length;
            document.getElementById('karyawanHadir').textContent = todayData.filter(item => item.role === 'karyawan').length;
            document.getElementById('siswaHadir').textContent = todayData.filter(item => item.role === 'siswa').length;
            document.getElementById('activeExams').textContent = examData.filter(exam => exam.status === 'active').length;
        }

        function renderAttendanceTable() {
            const tbody = document.getElementById('attendanceTable');
            const filteredData = getFilteredData();
            
            tbody.innerHTML = '';
            
            if (filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center space-y-2">
                                <span class="text-4xl">üìã</span>
                                <span>Belum ada data absensi</span>
                                <span class="text-sm">Data akan muncul setelah ada yang melakukan absensi</span>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                filteredData.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    
                    const time = new Date(item.timestamp).toLocaleString('id-ID');
                    const kelasJurusan = item.role === 'siswa' ? `${item.kelas} - ${item.jurusan}` : '-';
                    const attendanceTypeText = item.attendanceType === 'masuk' ? 'Masuk' : 'Pulang';
                    const status = item.status || 'NORMAL';
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-900">${time}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.name}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${getRoleBadgeClass(item.role)}">
                                ${item.role.charAt(0).toUpperCase() + item.role.slice(1)}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${item.attendanceType === 'masuk' ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800'}">
                                ${attendanceTypeText}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusBadgeClass(status)}">
                                ${status}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">${item.idNumber}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${kelasJurusan}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.location}</td>
                        <td class="px-4 py-3">
                            ${item.photo ? 
                                `<button onclick="showPhoto('${item.photo}')" class="text-blue-600 hover:text-blue-800 text-sm">Lihat Foto</button>` : 
                                `<span class="text-gray-400 text-sm">${item.isManualEntry ? 'Manual Entry' : 'Tidak ada foto'}</span>`
                            }
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }
            
            // Update last refresh timestamp
            updateLastRefreshTime();
        }

        function refreshData() {
            // Reload data from localStorage
            attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || [];
            examData = JSON.parse(localStorage.getItem('examData')) || [];
            examResults = JSON.parse(localStorage.getItem('examResults')) || [];
            teacherData = JSON.parse(localStorage.getItem('teacherData')) || [];
            subjectData = JSON.parse(localStorage.getItem('subjectData')) || [];
            
            // Update all displays
            updateStats();
            renderAttendanceTable();
            renderExamManagementTable();
            
            // Show refresh animation
            const refreshBtn = event.target.closest('button');
            const originalContent = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<span class="animate-spin">üîÑ</span><span>Memuat...</span>';
            refreshBtn.disabled = true;
            
            setTimeout(() => {
                refreshBtn.innerHTML = originalContent;
                refreshBtn.disabled = false;
            }, 1000);
            
            console.log('Data refreshed:', {
                attendance: attendanceData.length,
                exams: examData.length,
                results: examResults.length
            });
        }

        function updateLastRefreshTime() {
            const now = new Date().toLocaleTimeString('id-ID');
            const lastUpdateEl = document.getElementById('lastUpdate');
            if (lastUpdateEl) {
                lastUpdateEl.textContent = `Terakhir diperbarui: ${now}`;
            }
        }

        function getRoleBadgeClass(role) {
            switch(role) {
                case 'guru': return 'bg-green-100 text-green-800';
                case 'karyawan': return 'bg-blue-100 text-blue-800';
                case 'siswa': return 'bg-purple-100 text-purple-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function showPhoto(photoSrc) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="max-w-2xl max-h-full p-4">
                    <img src="${photoSrc}" class="max-w-full max-h-full rounded-lg shadow-lg" alt="Foto Absensi">
                    <button onclick="this.parentElement.parentElement.remove()" class="absolute top-4 right-4 text-white text-2xl hover:text-gray-300">
                        ‚úï
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function getFilteredData() {
            let filtered = [...attendanceData];
            
            const roleFilter = document.getElementById('filterRole').value;
            const typeFilter = document.getElementById('filterType').value;
            const dateFromFilter = document.getElementById('filterDateFrom').value;
            const dateToFilter = document.getElementById('filterDateTo').value;
            
            if (roleFilter) {
                filtered = filtered.filter(item => item.role === roleFilter);
            }
            
            if (typeFilter) {
                filtered = filtered.filter(item => item.attendanceType === typeFilter);
            }
            
            if (dateFromFilter) {
                filtered = filtered.filter(item => item.date >= dateFromFilter);
            }
            
            if (dateToFilter) {
                filtered = filtered.filter(item => item.date <= dateToFilter);
            }
            
            return filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        function filterData() {
            renderAttendanceTable();
        }

        function resetFilters() {
            document.getElementById('filterRole').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            renderAttendanceTable();
        }

        function exportToCSV() {
            const data = getFilteredData();
            if (data.length === 0) {
                alert('Tidak ada data untuk diekspor');
                return;
            }
            
            const headers = ['Waktu', 'Nama', 'Role', 'Jenis', 'Status', 'NIP/NIS', 'Kelas', 'Jurusan', 'Lokasi'];
            const csvContent = [
                headers.join(','),
                ...data.map(item => [
                    `"${new Date(item.timestamp).toLocaleString('id-ID')}"`,
                    `"${item.name}"`,
                    `"${item.role}"`,
                    `"${item.attendanceType === 'masuk' ? 'Masuk' : 'Pulang'}"`,
                    `"${item.status || 'NORMAL'}"`,
                    `"${item.idNumber}"`,
                    `"${item.kelas || '-'}"`,
                    `"${item.jurusan || '-'}"`,
                    `"${item.location}"`
                ].join(','))
            ].join('\n');
            
            downloadFile(csvContent, 'absensi.csv', 'text/csv');
        }

        function exportToExcel() {
            const data = getFilteredData();
            if (data.length === 0) {
                alert('Tidak ada data untuk diekspor');
                return;
            }
            
            let html = `
                <table border="1">
                    <tr>
                        <th>Waktu</th>
                        <th>Nama</th>
                        <th>Role</th>
                        <th>Jenis</th>
                        <th>Status</th>
                        <th>NIP/NIS</th>
                        <th>Kelas</th>
                        <th>Jurusan</th>
                        <th>Lokasi</th>
                    </tr>
            `;
            
            data.forEach(item => {
                html += `
                    <tr>
                        <td>${new Date(item.timestamp).toLocaleString('id-ID')}</td>
                        <td>${item.name}</td>
                        <td>${item.role}</td>
                        <td>${item.attendanceType === 'masuk' ? 'Masuk' : 'Pulang'}</td>
                        <td>${item.status || 'NORMAL'}</td>
                        <td>${item.idNumber}</td>
                        <td>${item.kelas || '-'}</td>
                        <td>${item.jurusan || '-'}</td>
                        <td>${item.location}</td>
                    </tr>
                `;
            });
            
            html += '</table>';
            
            downloadFile(html, 'absensi.xls', 'application/vnd.ms-excel');
        }

        function exportRecapToExcel() {
            const data = getFilteredData();
            if (data.length === 0) {
                alert('Tidak ada data untuk diekspor');
                return;
            }
            
            // Get filter values for header
            const roleFilter = document.getElementById('filterRole').value || 'Semua';
            const dateFromFilter = document.getElementById('filterDateFrom').value || '2025-01-01';
            const dateToFilter = document.getElementById('filterDateTo').value || new Date().toISOString().split('T')[0];
            
            // Group data by person
            const recap = {};
            
            data.forEach(item => {
                const key = `${item.name}_${item.idNumber}`;
                if (!recap[key]) {
                    recap[key] = {
                        name: item.name,
                        idNumber: item.idNumber,
                        role: item.role,
                        kelas: item.kelas || '-',
                        jurusan: item.jurusan || '-',
                        telat: 0,
                        sakit: 0,
                        izin: 0,
                        alpha: 0,
                        totalHadirHari: 0,
                        attendanceDays: new Set()
                    };
                }
                
                // Count attendance days (masuk entries only)
                if (item.attendanceType === 'masuk') {
                    recap[key].attendanceDays.add(item.date);
                    
                    // Count late attendance
                    if (item.status === 'TERLAMBAT') {
                        recap[key].telat++;
                    }
                }
                
                // Count manual entries by status (for masuk type only to avoid double counting)
                if (item.isManualEntry && item.attendanceType === 'masuk') {
                    switch(item.status) {
                        case 'SAKIT':
                            recap[key].sakit++;
                            break;
                        case 'IZIN':
                            recap[key].izin++;
                            break;
                        case 'ALPHA':
                            recap[key].alpha++;
                            break;
                        case 'HADIR':
                            recap[key].attendanceDays.add(item.date);
                            break;
                    }
                }
            });
            
            // Calculate final totals
            Object.values(recap).forEach(person => {
                // Total hari hadir (unique days with masuk attendance)
                person.totalHadirHari = person.attendanceDays.size;
                
                // Total Hadir Bersih = Total hari hadir - Total telat
                person.totalHadirBersih = Math.max(0, person.totalHadirHari - person.telat);
                
                delete person.attendanceDays;
            });
            
            let html = `
                <table border="1" style="border-collapse: collapse;">
                    <tr>
                        <td colspan="8" style="font-weight: bold; font-size: 16px; text-align: center; padding: 10px;">
                            Rekap Absensi
                        </td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold; padding: 5px;">Kelas</td>
                        <td colspan="7" style="padding: 5px;">${roleFilter === 'Semua' ? 'Semua Role' : roleFilter.charAt(0).toUpperCase() + roleFilter.slice(1)}</td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold; padding: 5px;">Periode</td>
                        <td colspan="7" style="padding: 5px;">${dateFromFilter} sampai ${dateToFilter}</td>
                    </tr>
                    <tr style="background-color: #f0f0f0;">
                        <th style="padding: 8px; text-align: center;">No</th>
                        <th style="padding: 8px; text-align: center;">Nama</th>
                        <th style="padding: 8px; text-align: center;">NIP/NIS</th>
                        <th style="padding: 8px; text-align: center;">Telat</th>
                        <th style="padding: 8px; text-align: center;">Sakit</th>
                        <th style="padding: 8px; text-align: center;">Izin</th>
                        <th style="padding: 8px; text-align: center;">Alpha</th>
                        <th style="padding: 8px; text-align: center;">Total Hadir (Hari)</th>
                    </tr>
            `;
            
            const recapArray = Object.values(recap);
            recapArray.forEach((person, index) => {
                html += `
                    <tr>
                        <td style="padding: 5px; text-align: center;">${index + 1}</td>
                        <td style="padding: 5px;">${person.name}</td>
                        <td style="padding: 5px; text-align: center;">${person.idNumber}</td>
                        <td style="padding: 5px; text-align: center;">${person.telat}</td>
                        <td style="padding: 5px; text-align: center;">${person.sakit}</td>
                        <td style="padding: 5px; text-align: center;">${person.izin}</td>
                        <td style="padding: 5px; text-align: center;">${person.alpha}</td>
                        <td style="padding: 5px; text-align: center;">${person.totalHadirBersih}</td>
                    </tr>
                `;
            });
            
            // Add summary row
            const totalTelat = recapArray.reduce((sum, p) => sum + p.telat, 0);
            const totalSakit = recapArray.reduce((sum, p) => sum + p.sakit, 0);
            const totalIzin = recapArray.reduce((sum, p) => sum + p.izin, 0);
            const totalAlpha = recapArray.reduce((sum, p) => sum + p.alpha, 0);
            const totalHadirHari = recapArray.reduce((sum, p) => sum + p.totalHadirBersih, 0);
            
            html += `
                    <tr style="background-color: #e0e0e0; font-weight: bold;">
                        <td colspan="3" style="padding: 8px; text-align: center;">TOTAL</td>
                        <td style="padding: 8px; text-align: center;">${totalTelat}</td>
                        <td style="padding: 8px; text-align: center;">${totalSakit}</td>
                        <td style="padding: 8px; text-align: center;">${totalIzin}</td>
                        <td style="padding: 8px; text-align: center;">${totalAlpha}</td>
                        <td style="padding: 8px; text-align: center;">${totalHadirHari}</td>
                    </tr>
                </table>
            `;
            
            const filename = `rekap-absensi-${dateFromFilter}-${dateToFilter}.xls`;
            downloadFile(html, filename, 'application/vnd.ms-excel');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Subject Management Functions
        function showSubjectManagement() {
            document.getElementById('subjectManagement').classList.remove('hidden');
            renderSubjectTable();
        }

        function hideSubjectManagement() {
            document.getElementById('subjectManagement').classList.add('hidden');
            document.getElementById('addSubjectForm').classList.add('hidden');
            document.getElementById('editSubjectForm').classList.add('hidden');
        }

        function showAddSubject() {
            document.getElementById('subjectManagement').classList.add('hidden');
            document.getElementById('addSubjectForm').classList.remove('hidden');
        }

        function hideAddSubject() {
            document.getElementById('addSubjectForm').classList.add('hidden');
            document.getElementById('subjectManagement').classList.remove('hidden');
            resetSubjectForm();
        }

        function showEditSubject(subjectId) {
            const subject = subjectData.find(s => s.id === subjectId);
            if (!subject) return;

            // Hide subject management table
            document.getElementById('subjectManagement').classList.add('hidden');

            document.getElementById('editSubjectId').value = subject.id;
            document.getElementById('editSubjectCode').value = subject.code;
            document.getElementById('editSubjectName').value = subject.name;
            document.getElementById('editSubjectCategory').value = subject.category;
            document.getElementById('editSubjectDescription').value = subject.description || '';

            // Set checkboxes for classes
            const checkboxes = document.querySelectorAll('.edit-subject-class-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = subject.classes.includes(checkbox.value);
            });

            document.getElementById('editSubjectForm').classList.remove('hidden');
        }

        function hideEditSubject() {
            document.getElementById('editSubjectForm').classList.add('hidden');
            document.getElementById('subjectManagement').classList.remove('hidden');
        }

        function resetSubjectForm() {
            document.getElementById('subjectCode').value = '';
            document.getElementById('subjectName').value = '';
            document.getElementById('subjectCategory').value = '';
            document.getElementById('subjectDescription').value = '';
            
            // Reset checkboxes
            const checkboxes = document.querySelectorAll('.subject-class-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = false);
        }

        function addSubject(event) {
            event.preventDefault();

            const code = document.getElementById('subjectCode').value;

            // Check if code already exists
            if (subjectData.some(subject => subject.code === code)) {
                alert('Kode mata pelajaran sudah ada! Silakan gunakan kode yang berbeda.');
                return;
            }

            // Get selected classes
            const selectedClasses = [];
            const checkboxes = document.querySelectorAll('.subject-class-checkbox:checked');
            checkboxes.forEach(checkbox => {
                selectedClasses.push(checkbox.value);
            });

            if (selectedClasses.length === 0) {
                alert('Silakan pilih minimal satu kelas!');
                return;
            }

            const newSubject = {
                id: Date.now(),
                code: code,
                name: document.getElementById('subjectName').value,
                category: document.getElementById('subjectCategory').value,
                classes: selectedClasses,
                description: document.getElementById('subjectDescription').value,
                status: 'active',
                createdAt: new Date().toISOString()
            };

            subjectData.push(newSubject);
            localStorage.setItem('subjectData', JSON.stringify(subjectData));

            alert('Mata pelajaran berhasil ditambahkan!');
            hideAddSubject();
            renderSubjectTable();
        }

        function updateSubject(event) {
            event.preventDefault();

            const subjectId = parseInt(document.getElementById('editSubjectId').value);
            const subjectIndex = subjectData.findIndex(s => s.id === subjectId);
            
            if (subjectIndex === -1) {
                alert('Data mata pelajaran tidak ditemukan!');
                return;
            }

            const code = document.getElementById('editSubjectCode').value;
            
            // Check if code already exists (excluding current subject)
            if (subjectData.some(subject => subject.code === code && subject.id !== subjectId)) {
                alert('Kode mata pelajaran sudah ada! Silakan gunakan kode yang berbeda.');
                return;
            }

            // Get selected classes
            const selectedClasses = [];
            const checkboxes = document.querySelectorAll('.edit-subject-class-checkbox:checked');
            checkboxes.forEach(checkbox => {
                selectedClasses.push(checkbox.value);
            });

            if (selectedClasses.length === 0) {
                alert('Silakan pilih minimal satu kelas!');
                return;
            }

            // Update subject data
            subjectData[subjectIndex].code = code;
            subjectData[subjectIndex].name = document.getElementById('editSubjectName').value;
            subjectData[subjectIndex].category = document.getElementById('editSubjectCategory').value;
            subjectData[subjectIndex].classes = selectedClasses;
            subjectData[subjectIndex].description = document.getElementById('editSubjectDescription').value;

            localStorage.setItem('subjectData', JSON.stringify(subjectData));

            alert('Data mata pelajaran berhasil diperbarui!');
            hideEditSubject();
            renderSubjectTable();
        }

        function deleteSubject(subjectId) {
            if (confirm('Apakah Anda yakin ingin menghapus mata pelajaran ini?')) {
                subjectData = subjectData.filter(s => s.id !== subjectId);
                localStorage.setItem('subjectData', JSON.stringify(subjectData));
                renderSubjectTable();
                alert('Mata pelajaran berhasil dihapus!');
            }
        }

        function toggleSubjectStatus(subjectId) {
            const subject = subjectData.find(s => s.id === subjectId);
            if (subject) {
                subject.status = subject.status === 'active' ? 'inactive' : 'active';
                localStorage.setItem('subjectData', JSON.stringify(subjectData));
                renderSubjectTable();
            }
        }

        function renderSubjectTable() {
            const tbody = document.getElementById('subjectTable');
            tbody.innerHTML = '';

            if (subjectData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center space-y-2">
                                <span class="text-4xl">üìö</span>
                                <span>Belum ada mata pelajaran</span>
                                <span class="text-sm">Klik "Tambah Mata Pelajaran" untuk menambah data</span>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                subjectData.forEach(subject => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';

                    const classesText = subject.classes.length > 2 ? 
                        `${subject.classes.slice(0, 2).join(', ')} +${subject.classes.length - 2}` : 
                        subject.classes.join(', ');

                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${subject.code}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${subject.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${subject.category}</td>
                        <td class="px-4 py-3 text-sm text-gray-900" title="${subject.classes.join(', ')}">${classesText}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${subject.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${subject.status === 'active' ? 'Aktif' : 'Nonaktif'}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <button onclick="showEditSubject(${subject.id})" class="text-blue-600 hover:text-blue-800 text-sm mr-3">
                                Edit
                            </button>
                            <button onclick="toggleSubjectStatus(${subject.id})" class="text-yellow-600 hover:text-yellow-800 text-sm mr-3">
                                ${subject.status === 'active' ? 'Nonaktifkan' : 'Aktifkan'}
                            </button>
                            <button onclick="deleteSubject(${subject.id})" class="text-red-600 hover:text-red-800 text-sm">
                                Hapus
                            </button>
                        </td>
                    `;

                    tbody.appendChild(row);
                });
            }
        }

        // Manual Attendance Functions
        function showManualAttendance() {
            document.getElementById('manualAttendanceForm').classList.remove('hidden');
            
            // Set today's date and current time as default
            const now = new Date();
            document.getElementById('manualDate').value = now.toISOString().split('T')[0];
            document.getElementById('manualTime').value = now.toTimeString().slice(0, 5);
        }

        function hideManualAttendance() {
            document.getElementById('manualAttendanceForm').classList.add('hidden');
            resetManualAttendanceForm();
        }

        function toggleManualSiswaFields() {
            const role = document.getElementById('manualRole').value;
            const siswaFields = document.getElementById('manualSiswaFields');
            const kelasField = document.getElementById('manualKelas');
            const jurusanField = document.getElementById('manualJurusan');
            const nameSelect = document.getElementById('manualName');
            const nameInput = document.getElementById('manualNameInput');
            const idNumberField = document.getElementById('manualIdNumber');
            
            // Reset fields
            nameSelect.innerHTML = '<option value="">Pilih Nama</option>';
            nameInput.value = '';
            idNumberField.value = '';
            
            if (role === 'siswa') {
                siswaFields.classList.remove('hidden');
                kelasField.required = true;
                jurusanField.required = true;
                
                // Show input field for siswa
                nameSelect.classList.add('hidden');
                nameInput.classList.remove('hidden');
                nameSelect.required = false;
                nameInput.required = true;
            } else if (role === 'guru') {
                siswaFields.classList.add('hidden');
                kelasField.required = false;
                jurusanField.required = false;
                kelasField.value = '';
                jurusanField.value = '';
                
                // Show dropdown for guru and populate with teacher data
                nameSelect.classList.remove('hidden');
                nameInput.classList.add('hidden');
                nameSelect.required = true;
                nameInput.required = false;
                
                // Populate teacher dropdown
                teacherData.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.name;
                    option.textContent = teacher.name;
                    option.dataset.nip = teacher.nip;
                    nameSelect.appendChild(option);
                });
            } else {
                // For karyawan
                siswaFields.classList.add('hidden');
                kelasField.required = false;
                jurusanField.required = false;
                kelasField.value = '';
                jurusanField.value = '';
                
                // Show input field for karyawan
                nameSelect.classList.add('hidden');
                nameInput.classList.remove('hidden');
                nameSelect.required = false;
                nameInput.required = true;
            }
        }

        function fillTeacherData() {
            const nameSelect = document.getElementById('manualName');
            const selectedOption = nameSelect.options[nameSelect.selectedIndex];
            const idNumberField = document.getElementById('manualIdNumber');
            
            if (selectedOption && selectedOption.dataset.nip) {
                idNumberField.value = selectedOption.dataset.nip;
            } else {
                idNumberField.value = '';
            }
        }

        function resetManualAttendanceForm() {
            document.getElementById('manualRole').value = '';
            document.getElementById('manualName').innerHTML = '<option value="">Pilih Nama</option>';
            document.getElementById('manualNameInput').value = '';
            document.getElementById('manualIdNumber').value = '';
            document.getElementById('manualKelas').value = '';
            document.getElementById('manualJurusan').value = '';
            document.getElementById('manualAttendanceType').value = '';
            document.getElementById('manualStatus').value = '';
            document.getElementById('manualDate').value = '';
            document.getElementById('manualTime').value = '';
            document.getElementById('manualLocation').value = '';
            document.getElementById('manualKeterangan').value = '';
            
            // Hide siswa fields
            document.getElementById('manualSiswaFields').classList.add('hidden');
            document.getElementById('manualKelas').required = false;
            document.getElementById('manualJurusan').required = false;
            
            // Reset name field visibility
            document.getElementById('manualName').classList.add('hidden');
            document.getElementById('manualNameInput').classList.add('hidden');
            document.getElementById('manualName').required = false;
            document.getElementById('manualNameInput').required = false;
        }

        function addManualAttendance(event) {
            event.preventDefault();

            const role = document.getElementById('manualRole').value;
            const date = document.getElementById('manualDate').value;
            const time = document.getElementById('manualTime').value;
            
            // Get name based on role
            let name = '';
            if (role === 'guru') {
                name = document.getElementById('manualName').value;
            } else {
                name = document.getElementById('manualNameInput').value;
            }
            
            // Create timestamp from date and time
            const timestamp = new Date(`${date}T${time}`).toISOString();
            
            const formData = {
                id: Date.now(),
                timestamp: timestamp,
                role: role,
                attendanceType: document.getElementById('manualAttendanceType').value,
                status: document.getElementById('manualStatus').value,
                name: name,
                idNumber: document.getElementById('manualIdNumber').value,
                kelas: role === 'siswa' ? document.getElementById('manualKelas').value : '',
                jurusan: role === 'siswa' ? document.getElementById('manualJurusan').value : '',
                photo: null, // No photo for manual entry
                location: document.getElementById('manualLocation').value,
                date: date,
                keterangan: document.getElementById('manualKeterangan').value,
                isManualEntry: true, // Flag to identify manual entries
                enteredBy: 'Admin'
            };

            // Load existing data, add new entry, and save back
            let existingData = JSON.parse(localStorage.getItem('attendanceData')) || [];
            existingData.push(formData);
            localStorage.setItem('attendanceData', JSON.stringify(existingData));
            
            // Update global variable
            attendanceData = existingData;

            // Show success message
            const attendanceTypeText = formData.attendanceType === 'masuk' ? 'MASUK' : 'PULANG';
            let successMsg = `‚úÖ Absensi manual berhasil disimpan!\n\nDetail:\n- Nama: ${formData.name}\n- Role: ${formData.role.toUpperCase()}\n- Jenis: ${attendanceTypeText}\n- Status: ${formData.status}\n- Tanggal: ${new Date(formData.timestamp).toLocaleDateString('id-ID')}\n- Waktu: ${new Date(formData.timestamp).toLocaleTimeString('id-ID')}\n- Lokasi: ${formData.location}`;
            
            if (formData.keterangan) {
                successMsg += `\n- Keterangan: ${formData.keterangan}`;
            }
            
            alert(successMsg);

            hideManualAttendance();
            
            // Update stats and table
            updateStats();
            renderAttendanceTable();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'985071cfe2dfff8f',t:'MTc1ODg2NTQxNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
